<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Using Python to tackle the CPS (Part 3) | Tom's Blog</title>

                <link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

                <link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">

      <link rel="canonical" href="http://tomaugspurger.github.io/posts/tackling%20the%20cps%20(part%203).html">



    
        <!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->

    

    
    <meta name="author" content="Tom Augspurger">
        <meta property="og:site_name" content="Tom's Blog">
    <meta property="og:title" content="Using Python to tackle the CPS (Part 3)">
    <meta property="og:url" content="http://tomaugspurger.github.io/posts/tackling the cps (part 3).html">
    <meta property="og:description" content="In part 2 of this series, we set the stage to parse the data files themselves.
As a reminder, we have a dictionary that looks like
         id  length  start  end
0    HRHHID      15      1   15
1   H">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2014-05-19T12:00:00-05:00">

    
    

</head>
<body>
    <section class="social">
        <ul>
                    <li><a href="../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>

        </ul>
    </section>
    <section class="page-content">
        <div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">Using Python to tackle the CPS (Part 3)</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2014-05-19T12:00:00-05:00">2014-05-19 12:00</time>
            
                      |  
        <a href="tackling%20the%20cps%20(part%203).md" id="sourcelink">Source</a>

            </div>
            
        </div>
        <div class="body">
            <div>
<p>In <a href="http://tomaugspurger.github.io/blog/2014/02/04/tackling%20the%20cps%20(part%202)/">part 2</a> of this series, we set the stage to parse the data files themselves.</p>
<p>As a reminder, we have a dictionary that looks like</p>
<pre class="code literal-block">         <span class="nb">id</span>  <span class="n">length</span>  <span class="n">start</span>  <span class="n">end</span>
<span class="mi">0</span>    <span class="n">HRHHID</span>      <span class="mi">15</span>      <span class="mi">1</span>   <span class="mi">15</span>
<span class="mi">1</span>   <span class="n">HRMONTH</span>       <span class="mi">2</span>     <span class="mi">16</span>   <span class="mi">17</span>
<span class="mi">2</span>   <span class="n">HRYEAR4</span>       <span class="mi">4</span>     <span class="mi">18</span>   <span class="mi">21</span>
<span class="mi">3</span>  <span class="n">HURESPLI</span>       <span class="mi">2</span>     <span class="mi">22</span>   <span class="mi">23</span>
<span class="mi">4</span>   <span class="n">HUFINAL</span>       <span class="mi">3</span>     <span class="mi">24</span>   <span class="mi">26</span>
         <span class="o">...</span>     <span class="o">...</span>    <span class="o">...</span>  <span class="o">...</span>
</pre>


<p>giving the columns of the raw CPS data files. This post (or two) will describe the reading of the actual data files, and the somewhat tricky process of matching individuals across the different files. After that we can (finally) get into analyzing the data. The old joke is that statisticians spend 80% of their time munging their data, and 20% of their time complaining about munging their data. So 4 posts about data cleaning seems reasonable.</p>
<p>The data files are stored in fixed width format (FWF), one of the least human friendly ways to store data.
We want to get to an <a href="http://www.hdfgroup.org/HDF5/">HDF5</a> file, which is extremely fast and convinent with pandas.</p>
<p>Here's the first line of the raw data:</p>
<pre class="code literal-block">head -n 1 /Volumes/HDD/Users/tom/DataStorage/CPS/monthly/cpsb9401
881605952390 2  286-1 2201-1 1 1 1-1 1 5-1-1-1  22436991 1 2 1 6 194 2A61 -1 2 2-1-1-1-1 363 1-15240115 3-1 4 0 1-1 2 1-1660 1 2 2 2 6 236 2 8-1 0 1-1 1 1 1 2 1 2 57 57 57 1 0-1 2 5 3-1-1 2-1-1-1-1-1 2-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1 -1-1  169-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-1 0 4-1-1-1-1-1-1 -1-1-1 0 1 2-1-1-1-1-1-1-1-1-1 -1 -1-1-1 -1 -1-1-1 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 0-1-1-1-1-1  -1  -1  -1  0-1-1      0-1-1-1      -1      0-1-1-1-1-1-1-1-1 2-1-1-1-1  22436991        -1         0  22436991  22422317-1         0 0 0 1 0-1 050 0 0 0 011 0 0 0-1-1-1-1 0 0 0-1-1-1-1-1-1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1 1 1 1 1 1 1 1 1 1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1 1 1-1-1-1
</pre>


<p>We'll use pandas' <a href="http://pandas.pydata.org/pandas-docs/version/0.13.0/generated/pandas.io.parsers.read_fwf.html#pandas.io.parsers.read_fwf"><code>read_fwf</code></a> parser, passing in the widths we got from last post.
One note of warning, the <code>read_fwf</code> function is slow. It's written in plain python, and really makes you appreciate <a href="http://wesmckinney.com/blog/?p=543">all the work</a> Wes (the creater or pandas) put into making <code>read_csv</code> fast.</p>
<p>Start by looking at the <code>__main__</code> <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_hdf_store.py#L786">entry point</a>. The basic idea is to call <code>python make_hdf.py</code> with an optional argument giving a file with a specific set of months you want to process. Otherwise, it processes every month in your data folder. There's a bit of setup to make sure everything is order, and then we jump to the <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_hdf_store.py#L813">next important line</a>:</p>
<pre class="code literal-block"><span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
    <span class="n">append_to_store</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">skips</span><span class="p">,</span> <span class="n">dds</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
</pre>


<p>I'd like to think that <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_hdf_store.py#L725">this function</a> is fairly straightforward. We generate the names I use internally (<code>name</code>), read in the data dictionary that we parsed last time (<code>dd</code> and <code>widths</code>), and get to work reading the actual data with</p>
<pre class="code literal-block"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">'.gz'</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="n">widths</span><span class="p">,</span>
                 <span class="n">names</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">)</span>
</pre>


<p>Rather than stepping through every part of the processing (checking types, making sure indexes are unique, handling missing values, etc.) I want to focus on one specific issue: handling special cases. Since the CPS data aren't consistent month to month, I needed a way transform the data for certain months differently that for others. The design I came up with worked pretty well.</p>
<p>The solution is in <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_hdf_store.py#L603"><code>special_by_dd</code></a>. Basically, each data dictionary (which describes the data layout for a month) has its own little quirks.
For example, the data dictionary starting in January 1989 spread the two digits for age across two fields. The fix itself is extremely simple: <code>df["PRTAGE"] = df["AdAGEDG1"] * 10 + df["AdAGEDG2"]</code>, but knowing when to apply this fix, and how to apply several of these fixes is the interesting part.</p>
<p>In <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_hdf_store.py#L603"><code>special_by_dd</code></a>, I created a handful of closures (basically just functions inside other functions), and a dictionary mapping names to those functions.</p>
<pre class="code literal-block"><span class="n">func_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">"expand_year"</span><span class="p">:</span> <span class="n">expand_year</span><span class="p">,</span> <span class="s">"combine_age"</span><span class="p">:</span> <span class="n">combine_age</span><span class="p">,</span>
             <span class="s">"expand_hours"</span><span class="p">:</span> <span class="n">expand_hours</span><span class="p">,</span> <span class="s">"align_lfsr"</span><span class="p">:</span> <span class="n">align_lfsr</span><span class="p">,</span>
             <span class="s">"combine_hours"</span><span class="p">:</span> <span class="n">combine_hours</span><span class="p">}</span>
</pre>


<p>Each one of these functions takes a DataFrame and returns a DataFrame, with the fix applied. The example above is <code>combine_age</code>.
In a settings file, I had a JSON object mapping the data dictionary name to special functions to apply. For example, January 1989's special case list was:</p>
<pre class="code literal-block">"jan1989": ["expand_year", "combine_age", "align_lfsr", "expand_hours", "combine_hours"]
</pre>


<p>I get the necessary special case functions and apply each with</p>
<pre class="code literal-block">specials = special_by_dd(settings["special_by_dd"][dd_name])
for func in specials:
    df = specials[func](df, dd_name)
</pre>


<p><code>specials</code> is just <code>func_dict</code> from above, but filtered to be only the functions specified in the settings file.
We select the function from the dictionary with <code>specials[func]</code> and then directly call it with <code>(df, dd_name)</code>.
Since functions are objects in python, we're able to store them in dictionaries and pass them around like just about anything else.</p>
<p>This method gave a lot of flexibility. When I discovered a new way that one month's layout differed from what I wanted, I simply wrote a function to handle the special case, added it to <code>func_dict</code>, and added the new special case to that month's speical case list.</p>
<p>There's a bit more standardization and other boring stuff that gets us to a good place: each month with the same layout. Now we get get to the tricky alignment, which I'll save for another post.</p>
</div>
        </div>
                <ul class="pager">
            <li class="previous">
                <a href="Quiz%2010%20Review.html" rel="prev" title="Stats for Strategy Quiz 10 Review">Previous post</a>
            </li>
            <li class="next">
                <a href="tackling%20the%20cps%20(part%204).html" rel="next" title="Using Python to tackle the CPS (Part 4)">Next post</a>
            </li>
        </ul>

    </div>
                    <footer id="footer" role="contentinfo">
            <p>Contents © 2015         <a href="mailto:tom.w.augspurger@gmail.com">Tom Augspurger</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>

        </div>
    </section>
    
    
                <script src="../assets/js/all-nocdn.js" type="text/javascript"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


        <script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
