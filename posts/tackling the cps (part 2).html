<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Using Python to tackle the CPS (Part 2) | Tom's Blog</title>

                <link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

                <link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">

      <link rel="canonical" href="http://tomaugspurger.github.io/posts/tackling%20the%20cps%20(part%202).html">



    
        <!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->

    

    
    <meta name="author" content="Tom Augspurger">
        <meta property="og:site_name" content="Tom's Blog">
    <meta property="og:title" content="Using Python to tackle the CPS (Part 2)">
    <meta property="og:url" content="http://tomaugspurger.github.io/posts/tackling the cps (part 2).html">
    <meta property="og:description" content="Last time, we used Python to fetch some data from the Current Population Survey. Today, we'll work on parsing the files we just downloaded.

We downloaded two types of files last time:

CPS monthly ta">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2014-02-04T12:00:00-06:00">

    
    

</head>
<body>
    <section class="social">
        <ul>
                    <li><a href="../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>

        </ul>
    </section>
    <section class="page-content">
        <div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">Using Python to tackle the CPS (Part 2)</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2014-02-04T12:00:00-06:00">2014-02-04 12:00</time>
            
                      |  
        <a href="tackling%20the%20cps%20(part%202).md" id="sourcelink">Source</a>

            </div>
            
        </div>
        <div class="body">
            <div>
<p><a href="http://tomaugspurger.github.io/blog/2014/01/27/tackling%20the%20cps/">Last time</a>, we used Python to fetch some data from the <a href="http://www.census.gov/cps/">Current Population Survey</a>. Today, we'll work on parsing the files we just downloaded.</p>
<hr>
<p>We downloaded two types of files last time:</p>
<ul>
<li>CPS monthly tables: a fixed-width format text file with the actual data</li>
<li>Data Dictionaries: a text file describing the layout of the monthly tables</li>
</ul>
<p>Our goal is to parse the monthly tables. Here's the first two lines from the unzipped January 1994 file:</p>
<pre class="code literal-block">/V/H/U/t/D/C/monthly head -n <span class="m">2</span> cpsb9401
<span class="m">881605952390</span> <span class="m">2</span>  286-1 2201-1 <span class="m">1</span> <span class="m">1</span> 1-1 <span class="m">1</span> 5-1-1-1  <span class="m">22436991</span> <span class="m">1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">6</span> <span class="m">194</span> 2A61 -1 <span class="m">2</span> 2-1-1-1-1 <span class="m">363</span> 1-15240115 3-1 <span class="m">4</span> <span class="m">0</span> 1-1 <span class="m">2</span> 1-1660 <span class="m">1</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">6</span> <span class="m">236</span> <span class="m">2</span> 8-1 <span class="m">0</span> 1-1 <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">2</span> <span class="m">57</span> <span class="m">57</span> <span class="m">57</span> <span class="m">1</span> 0-1 <span class="m">2</span> <span class="m">5</span> 3-1-1 2-1-1-1-1-1 2-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1 -1-1  169-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-1 <span class="m">0</span> 4-1-1-1-1-1-1 -1-1-1 <span class="m">0</span> <span class="m">1</span> 2-1-1-1-1-1-1-1-1-1 -1 -1-1-1 -1 -1-1-1 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 0-1-1-1-1-1  -1  -1  -1  0-1-1      0-1-1-1      -1      0-1-1-1-1-1-1-1-1 2-1-1-1-1  <span class="m">22436991</span>        -1         <span class="m">0</span>  <span class="m">22436991</span>  22422317-1         <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> 0-1 <span class="m">050</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">011</span> <span class="m">0</span> <span class="m">0</span> 0-1-1-1-1 <span class="m">0</span> <span class="m">0</span> 0-1-1-1-1-1-1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 <span class="m">1</span> <span class="m">1</span> 1-1-1-1
<span class="m">881605952390</span> <span class="m">2</span>  286-1 2201-1 <span class="m">1</span> <span class="m">1</span> 1-1 <span class="m">1</span> 5-1-1-1  <span class="m">22436991</span> <span class="m">1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">6</span> <span class="m">194</span> 2A61 -1 <span class="m">2</span> 2-1-1-1-1 <span class="m">363</span> 1-15240115 3-1 <span class="m">4</span> <span class="m">0</span> 1-1 <span class="m">2</span> 3-1580 <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">239</span> <span class="m">2</span> 8-1 <span class="m">0</span> 2-1 <span class="m">1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">2</span> <span class="m">57</span> <span class="m">57</span> <span class="m">57</span> <span class="m">1</span> 0-1 <span class="m">1</span> <span class="m">1</span> 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-140-1-1 40-1-1-1-1 2-1 2-140-1 40-1   -1 <span class="m">2</span> <span class="m">5</span> 5-1 <span class="m">2</span> <span class="m">3</span> <span class="m">5</span> 2-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1-118 <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> 4-1-1-1 -1 1-1 <span class="m">1</span> 2-1-1-1-1-1-1-1 <span class="m">4</span> 1242705-1-1-1 -1  3-1-1 <span class="m">1</span> <span class="m">2</span> 4-1 <span class="m">1</span> 6-1 6-136-1 <span class="m">1</span> 4-110-1 <span class="m">3</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> 0-1-1-1-1  -1-1  -1  -1  0-1-1      0-1-1-1            -10-1-1-1-1-1-1-1-1-1-1-1-1-1  <span class="m">22436991</span>        -1         <span class="m">0</span>  <span class="m">31870604</span>  25650291-1         <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> 0-1 <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> 0-1-1-1-1 <span class="m">0</span> 0-1 <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 <span class="m">0</span> <span class="m">0</span> 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1
</pre>


<p>Clearly, we'll need to parse the data dictionaries before being able to make sense of that.</p>
<p>Keeping with the CPS's tradition of consistently being inconsistent, the data dictionaries don't have a consistent schema across the years. Here's a typical example for some years (this one is from January 2003):</p>
<pre class="code literal-block">NAME         SIZE  DESCRIPTION                          LOCATION

HRHHID          15     HOUSEHOLD IDENTIFIER   (Part 1)             (1 - 15)

                   EDITED UNIVERSE: ALL HHLD's IN SAMPLE

                   Part 1. See Characters 71-75 for Part 2 of the Household Identifier.
                   Use Part 1 only for matching backward in time and use in combination
                   with Part 2 for matching forward in time.
</pre>


<p>My goal was to extract 4 fields (<code>name</code>, <code>size</code>, <code>start</code>, <code>end</code>). Name and size could be taken directly (<code>HRHHID</code>, and <code>15</code>). <code>start</code> and <code>end</code> would be pulled from the <code>LOCATION</code> part.</p>
<p>In <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/generic_data_dictionary_parser.py"><code>generic_data_dictionary_parser</code></a>, I define a class do this. The main object <code>Parser</code>, takes</p>
<ul>
<li>
<code>infile</code>: the path to a data dictionary we downloaded</li>
<li>
<code>outfile</code>: path to an <a href="http://pandas.pydata.org/pandas-docs/dev/io.html#hdf5-pytables">HDF5</a> file</li>
<li>
<code>style</code>: A string representing the year of the data dictionary. Different years are formatted differently, so I define a style for each (3 styles in all)</li>
<li>
<code>regex</code>: This was mostly for testing. If you don't pass a <code>regex</code> it will be inferred from the style.</li>
</ul>
<p>The heart of the parser is a regex that matches on lines like <code>HRHHID          15     HOUSEHOLD IDENTIFIER   (Part 1)             (1 - 15)</code>, but nowhere else. After many hours, failures, and false positives, I came up with something roughly like <code>ur'[\x0c]{0,1}(\w+)[\s\t]*(\d{1,2})[\s\t]*(.*?)[\s\t]*\(*(\d+)\s*-\s*(\d+)\)*$'</code> <a href="http://regex101.com/r/uH5iH7">Here's</a> an explanation, but the gist is that</p>
<ul>
<li>
<code>\w+</code> matches words (like <code>HRHHID</code>)</li>
<li>there's some spaces or tabs <code>[\s\t]*</code> (yes the CPS mixes spaces and tabs) between that and...</li>
<li>size <code>\d{1,2}</code> which is 1 or two columns digits</li>
<li>the description which we don't really care about</li>
<li>the start and end positions <code>(*(\d+)\s*-\s*(\d+)\)*$</code> broken into two groups.</li>
</ul>
<p>Like I said, that's the heart of the parser. Unfortunately I had to pad the file with some 200+ more lines of code to handle special cases, formatting, and mistakes in the data dictionary itself.</p>
<p>The end result is a nice <code>HDFStore</code>, with a parsed version of each data dictionary looking like:</p>
<pre class="code literal-block">         id  length  start  end
0    HRHHID      15      1   15
1   HRMONTH       2     16   17
2   HRYEAR4       4     18   21
3  HURESPLI       2     22   23
4   HUFINAL       3     24   26
         ...     ...    ...  ...
</pre>


<p>This can be used as an argument pandas' <a href="http://pandas.pydata.org/pandas-docs/dev/io.html#files-with-fixed-width-columns"><code>read_fwf</code></a> parser.</p>
<p>Next time I'll talk about actually parsing the tables and wrangling them into a usable structure. After that, we will finally get to actually analyzing the data.</p>
</div>
        </div>
                <ul class="pager">
            <li class="previous">
                <a href="Discussion%20Review.html" rel="prev" title="Quiz 1 Review">Previous post</a>
            </li>
            <li class="next">
                <a href="Quiz%202%20Review.html" rel="next" title="Stats for Strategy Quiz 2 Review">Next post</a>
            </li>
        </ul>

    </div>
                    <footer id="footer" role="contentinfo">
            <p>Contents © 2015         <a href="mailto:tom.w.augspurger@gmail.com">Tom Augspurger</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>

        </div>
    </section>
    
    
                <script src="../assets/js/all-nocdn.js" type="text/javascript"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


        <script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
