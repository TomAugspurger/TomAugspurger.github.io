<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Python to tackle the CPS (Part 2) | Tom's Blog</title><meta name=keywords content="pandas"><meta name=description content="Last time, we used Python to fetch some data from the Current Population Survey. Today, we&rsquo;ll work on parsing the files we just downloaded.
We downloaded two types of files last time:
CPS monthly tables: a fixed-width format text file with the actual data Data Dictionaries: a text file describing the layout of the monthly tables Our goal is to parse the monthly tables. Here&rsquo;s the first two lines from the unzipped January 1994 file:"><meta name=author content><link rel=canonical href=https://tomaugspurger.github.io/posts/tackling-the-cps-part-2/><link crossorigin=anonymous href=/assets/css/stylesheet.67b4a5a78be69ca812d40e5543fbd83efd0b0cc5025c2505fd7758fd5d32ec2e.css integrity="sha256-Z7Slp4vmnKgS1A5VQ/vYPv0LDMUCXCUF/XdY/V0y7C4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://tomaugspurger.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tomaugspurger.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tomaugspurger.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tomaugspurger.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tomaugspurger.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Using Python to tackle the CPS (Part 2)"><meta property="og:description" content="Last time, we used Python to fetch some data from the Current Population Survey. Today, we&rsquo;ll work on parsing the files we just downloaded.
We downloaded two types of files last time:
CPS monthly tables: a fixed-width format text file with the actual data Data Dictionaries: a text file describing the layout of the monthly tables Our goal is to parse the monthly tables. Here&rsquo;s the first two lines from the unzipped January 1994 file:"><meta property="og:type" content="article"><meta property="og:url" content="https://tomaugspurger.github.io/posts/tackling-the-cps-part-2/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Python to tackle the CPS (Part 2)"><meta name=twitter:description content="Last time, we used Python to fetch some data from the Current Population Survey. Today, we&rsquo;ll work on parsing the files we just downloaded.
We downloaded two types of files last time:
CPS monthly tables: a fixed-width format text file with the actual data Data Dictionaries: a text file describing the layout of the monthly tables Our goal is to parse the monthly tables. Here&rsquo;s the first two lines from the unzipped January 1994 file:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://tomaugspurger.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Using Python to tackle the CPS (Part 2)","item":"https://tomaugspurger.github.io/posts/tackling-the-cps-part-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Python to tackle the CPS (Part 2)","name":"Using Python to tackle the CPS (Part 2)","description":"Last time, we used Python to fetch some data from the Current Population Survey. Today, we\u0026rsquo;ll work on parsing the files we just downloaded.\nWe downloaded two types of files last time:\nCPS monthly tables: a fixed-width format text file with the actual data Data Dictionaries: a text file describing the layout of the monthly tables Our goal is to parse the monthly tables. Here\u0026rsquo;s the first two lines from the unzipped January 1994 file:","keywords":["pandas"],"articleBody":"Last time, we used Python to fetch some data from the Current Population Survey. Today, we’ll work on parsing the files we just downloaded.\nWe downloaded two types of files last time:\nCPS monthly tables: a fixed-width format text file with the actual data Data Dictionaries: a text file describing the layout of the monthly tables Our goal is to parse the monthly tables. Here’s the first two lines from the unzipped January 1994 file:\n/V/H/U/t/D/C/monthly head -n 2 cpsb9401 881605952390 2 286-1 2201-1 1 1 1-1 1 5-1-1-1 22436991 1 2 1 6 194 2A61 -1 2 2-1-1-1-1 363 1-15240115 3-1 4 0 1-1 2 1-1660 1 2 2 2 6 236 2 8-1 0 1-1 1 1 1 2 1 2 57 57 57 1 0-1 2 5 3-1-1 2-1-1-1-1-1 2-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1 -1-1 169-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-1 0 4-1-1-1-1-1-1 -1-1-1 0 1 2-1-1-1-1-1-1-1-1-1 -1 -1-1-1 -1 -1-1-1 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 0-1-1-1-1-1 -1 -1 -1 0-1-1 0-1-1-1 -1 0-1-1-1-1-1-1-1-1 2-1-1-1-1 22436991 -1 0 22436991 22422317-1 0 0 0 1 0-1 050 0 0 0 011 0 0 0-1-1-1-1 0 0 0-1-1-1-1-1-1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1 1 1 1 1 1 1 1 1 1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1 1 1-1-1-1 881605952390 2 286-1 2201-1 1 1 1-1 1 5-1-1-1 22436991 1 2 1 6 194 2A61 -1 2 2-1-1-1-1 363 1-15240115 3-1 4 0 1-1 2 3-1580 1 1 1 1 2 239 2 8-1 0 2-1 1 2 1 2 1 2 57 57 57 1 0-1 1 1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-140-1-1 40-1-1-1-1 2-1 2-140-1 40-1 -1 2 5 5-1 2 3 5 2-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1-118 1 1 1 4-1-1-1 -1 1-1 1 2-1-1-1-1-1-1-1 4 1242705-1-1-1 -1 3-1-1 1 2 4-1 1 6-1 6-136-1 1 4-110-1 3 1 1 1 0-1-1-1-1 -1-1 -1 -1 0-1-1 0-1-1-1 -10-1-1-1-1-1-1-1-1-1-1-1-1-1 22436991 -1 0 31870604 25650291-1 0 0 0 1 0-1 0 1 0 0 0 0 0 0 0 0-1-1-1-1 0 0-1 1 1 0 1 0 1 1 0 1 1 1 0 1 0 1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 0 0 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 Clearly, we’ll need to parse the data dictionaries before being able to make sense of that.\nKeeping with the CPS’s tradition of consistently being inconsistent, the data dictionaries don’t have a consistent schema across the years. Here’s a typical example for some years (this one is from January 2003):\nNAME SIZE DESCRIPTION LOCATION HRHHID 15 HOUSEHOLD IDENTIFIER (Part 1) (1 - 15) EDITED UNIVERSE: ALL HHLD's IN SAMPLE Part 1. See Characters 71-75 for Part 2 of the Household Identifier. Use Part 1 only for matching backward in time and use in combination with Part 2 for matching forward in time. My goal was to extract 4 fields (name, size, start, end). Name and size could be taken directly (HRHHID, and 15). start and end would be pulled from the LOCATION part.\nIn generic_data_dictionary_parser, I define a class do this. The main object Parser, takes\ninfile: the path to a data dictionary we downloaded outfile: path to an HDF5 file style: A string representing the year of the data dictionary. Different years are formatted differently, so I define a style for each (3 styles in all) regex: This was mostly for testing. If you don’t pass a regex it will be inferred from the style. The heart of the parser is a regex that matches on lines like HRHHID 15 HOUSEHOLD IDENTIFIER (Part 1) (1 - 15), but nowhere else. After many hours, failures, and false positives, I came up with something roughly like ur'[\\x0c]{0,1}(\\w+)[\\s\\t]*(\\d{1,2})[\\s\\t]*(.*?)[\\s\\t]*\\(*(\\d+)\\s*-\\s*(\\d+)\\)*$' Here’s an explanation, but the gist is that\n\\w+ matches words (like HRHHID) there’s some spaces or tabs [\\s\\t]* (yes the CPS mixes spaces and tabs) between that and… size \\d{1,2} which is 1 or two columns digits the description which we don’t really care about the start and end positions (*(\\d+)\\s*-\\s*(\\d+)\\)*$ broken into two groups. Like I said, that’s the heart of the parser. Unfortunately I had to pad the file with some 200+ more lines of code to handle special cases, formatting, and mistakes in the data dictionary itself.\nThe end result is a nice HDFStore, with a parsed version of each data dictionary looking like:\nid length start end 0 HRHHID 15 1 15 1 HRMONTH 2 16 17 2 HRYEAR4 4 18 21 3 HURESPLI 2 22 23 4 HUFINAL 3 24 26 ... ... ... ... This can be used as an argument pandas’ read_fwf parser.\nNext time I’ll talk about actually parsing the tables and wrangling them into a usable structure. After that, we will finally get to actually analyzing the data.\n","wordCount":"757","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tomaugspurger.github.io/posts/tackling-the-cps-part-2/"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://tomaugspurger.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tomaugspurger.github.io accesskey=h title="Tom's Blog (Alt + H)">Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tomaugspurger.github.io/about/ title=About><span>About</span></a></li><li><a href=https://tomaugspurger.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://tomaugspurger.github.io/index.xml title=RSS><span>RSS</span></a></li><li><a href=https://tomaugspurger.github.io/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using Python to tackle the CPS (Part 2)</h1><div class=post-meta></div></header><div class=post-content><p><a href=http://tomaugspurger.github.io/blog/2014/01/27/tackling%20the%20cps/>Last time</a>, we used Python to fetch some data from the <a href=http://www.census.gov/cps/>Current Population Survey</a>. Today, we&rsquo;ll work on parsing the files we just downloaded.</p><hr><p>We downloaded two types of files last time:</p><ul><li>CPS monthly tables: a fixed-width format text file with the actual data</li><li>Data Dictionaries: a text file describing the layout of the monthly tables</li></ul><p>Our goal is to parse the monthly tables. Here&rsquo;s the first two lines from the unzipped January 1994 file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/V/H/U/t/D/C/monthly head -n <span style=color:#ae81ff>2</span> cpsb9401
</span></span><span style=display:flex><span><span style=color:#ae81ff>881605952390</span> <span style=color:#ae81ff>2</span>  286-1 2201-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 1-1 <span style=color:#ae81ff>1</span> 5-1-1-1  <span style=color:#ae81ff>22436991</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>194</span> 2A61 -1 <span style=color:#ae81ff>2</span> 2-1-1-1-1 <span style=color:#ae81ff>363</span> 1-15240115 3-1 <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>0</span> 1-1 <span style=color:#ae81ff>2</span> 1-1660 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>236</span> <span style=color:#ae81ff>2</span> 8-1 <span style=color:#ae81ff>0</span> 1-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>1</span> 0-1 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> 3-1-1 2-1-1-1-1-1 2-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1 -1-1  169-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-1 <span style=color:#ae81ff>0</span> 4-1-1-1-1-1-1 -1-1-1 <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> 2-1-1-1-1-1-1-1-1-1 -1 -1-1-1 -1 -1-1-1 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 0-1-1-1-1-1  -1  -1  -1  0-1-1      0-1-1-1      -1      0-1-1-1-1-1-1-1-1 2-1-1-1-1  <span style=color:#ae81ff>22436991</span>        -1         <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>22436991</span>  22422317-1         <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> 0-1 <span style=color:#ae81ff>050</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>011</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> 0-1-1-1-1 <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> 0-1-1-1-1-1-1 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 1-1-1-1
</span></span><span style=display:flex><span><span style=color:#ae81ff>881605952390</span> <span style=color:#ae81ff>2</span>  286-1 2201-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 1-1 <span style=color:#ae81ff>1</span> 5-1-1-1  <span style=color:#ae81ff>22436991</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>194</span> 2A61 -1 <span style=color:#ae81ff>2</span> 2-1-1-1-1 <span style=color:#ae81ff>363</span> 1-15240115 3-1 <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>0</span> 1-1 <span style=color:#ae81ff>2</span> 3-1580 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>239</span> <span style=color:#ae81ff>2</span> 8-1 <span style=color:#ae81ff>0</span> 2-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>1</span> 0-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 2-140-1-1 40-1-1-1-1 2-1 2-140-1 40-1   -1 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> 5-1 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> 2-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 -1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 1-118 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 4-1-1-1 -1 1-1 <span style=color:#ae81ff>1</span> 2-1-1-1-1-1-1-1 <span style=color:#ae81ff>4</span> 1242705-1-1-1 -1  3-1-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> 4-1 <span style=color:#ae81ff>1</span> 6-1 6-136-1 <span style=color:#ae81ff>1</span> 4-110-1 <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> 0-1-1-1-1  -1-1  -1  -1  0-1-1      0-1-1-1            -10-1-1-1-1-1-1-1-1-1-1-1-1-1  <span style=color:#ae81ff>22436991</span>        -1         <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>31870604</span>  25650291-1         <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> 0-1 <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> 0-1-1-1-1 <span style=color:#ae81ff>0</span> 0-1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> 1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1 <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> 0-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1
</span></span></code></pre></div><p>Clearly, we&rsquo;ll need to parse the data dictionaries before being able to make sense of that.</p><p>Keeping with the CPS&rsquo;s tradition of consistently being inconsistent, the data dictionaries don&rsquo;t have a consistent schema across the years. Here&rsquo;s a typical example for some years (this one is from January 2003):</p><pre tabindex=0><code>NAME         SIZE  DESCRIPTION                          LOCATION

HRHHID          15     HOUSEHOLD IDENTIFIER   (Part 1)             (1 - 15)

                   EDITED UNIVERSE: ALL HHLD&#39;s IN SAMPLE

                   Part 1. See Characters 71-75 for Part 2 of the Household Identifier.
                   Use Part 1 only for matching backward in time and use in combination
                   with Part 2 for matching forward in time.
</code></pre><p>My goal was to extract 4 fields (<code>name</code>, <code>size</code>, <code>start</code>, <code>end</code>). Name and size could be taken directly (<code>HRHHID</code>, and <code>15</code>). <code>start</code> and <code>end</code> would be pulled from the <code>LOCATION</code> part.</p><p>In <a href=https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/generic_data_dictionary_parser.py><code>generic_data_dictionary_parser</code></a>, I define a class do this. The main object <code>Parser</code>, takes</p><ul><li><code>infile</code>: the path to a data dictionary we downloaded</li><li><code>outfile</code>: path to an <a href=http://pandas.pydata.org/pandas-docs/dev/io.html#hdf5-pytables>HDF5</a> file</li><li><code>style</code>: A string representing the year of the data dictionary. Different years are formatted differently, so I define a style for each (3 styles in all)</li><li><code>regex</code>: This was mostly for testing. If you don&rsquo;t pass a <code>regex</code> it will be inferred from the style.</li></ul><p>The heart of the parser is a regex that matches on lines like <code>HRHHID 15 HOUSEHOLD IDENTIFIER (Part 1) (1 - 15)</code>, but nowhere else. After many hours, failures, and false positives, I came up with something roughly like <code>ur'[\x0c]{0,1}(\w+)[\s\t]*(\d{1,2})[\s\t]*(.*?)[\s\t]*\(*(\d+)\s*-\s*(\d+)\)*$'</code> <a href=http://regex101.com/r/uH5iH7>Here&rsquo;s</a> an explanation, but the gist is that</p><ul><li><code>\w+</code> matches words (like <code>HRHHID</code>)</li><li>there&rsquo;s some spaces or tabs <code>[\s\t]*</code> (yes the CPS mixes spaces and tabs) between that and&mldr;</li><li>size <code>\d{1,2}</code> which is 1 or two columns digits</li><li>the description which we don&rsquo;t really care about</li><li>the start and end positions <code>(*(\d+)\s*-\s*(\d+)\)*$</code> broken into two groups.</li></ul><p>Like I said, that&rsquo;s the heart of the parser. Unfortunately I had to pad the file with some 200+ more lines of code to handle special cases, formatting, and mistakes in the data dictionary itself.</p><p>The end result is a nice <code>HDFStore</code>, with a parsed version of each data dictionary looking like:</p><pre tabindex=0><code>         id  length  start  end
0    HRHHID      15      1   15
1   HRMONTH       2     16   17
2   HRYEAR4       4     18   21
3  HURESPLI       2     22   23
4   HUFINAL       3     24   26
         ...     ...    ...  ...
</code></pre><p>This can be used as an argument pandas&rsquo; <a href=http://pandas.pydata.org/pandas-docs/dev/io.html#files-with-fixed-width-columns><code>read_fwf</code></a> parser.</p><p>Next time I&rsquo;ll talk about actually parsing the tables and wrangling them into a usable structure. After that, we will finally get to actually analyzing the data.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tomaugspurger.github.io/tags/pandas/>pandas</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://tomaugspurger.github.io>Tom's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>