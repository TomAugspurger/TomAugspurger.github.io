<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Using Python to tackle the CPS (Part 4) | Tom's Blog</title>

                <link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

                <link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">

      <link rel="canonical" href="http://tomaugspurger.github.io/posts/tackling%20the%20cps%20(part%204).html">



    
        <!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->

    

    
    <meta name="author" content="Tom Augspurger">
        <meta property="og:site_name" content="Tom's Blog">
    <meta property="og:title" content="Using Python to tackle the CPS (Part 4)">
    <meta property="og:url" content="http://tomaugspurger.github.io/posts/tackling the cps (part 4).html">
    <meta property="og:description" content="Last time, we got to where we'd like to have started: One file per month, with each month laid out the same.
As a reminder, the CPS interviews households 8 times over the course of 16 months. They're ">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2014-05-19T12:01:00-05:00">

    
    

</head>
<body>
    <section class="social">
        <ul>
                    <li><a href="../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>

        </ul>
    </section>
    <section class="page-content">
        <div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">Using Python to tackle the CPS (Part 4)</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2014-05-19T12:01:00-05:00">2014-05-19 12:01</time>
            
                      |  
        <a href="tackling%20the%20cps%20(part%204).md" id="sourcelink">Source</a>

            </div>
            
        </div>
        <div class="body">
            <div>
<p>Last time, we got to where we'd like to have started: One file per month, with each month laid out the same.</p>
<p>As a reminder, the CPS interviews households 8 times over the course of 16 months. They're interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you're also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$.</p>
<p>I stored the data in <a href="http://pandas-docs.github.io/pandas-docs-travis/dsintro.html#panel">Panels</a>, the less well-known, higher-dimensional cousin of the <a href="http://pandas.pydata.org/pandas-docs/version/0.13.1/generated/pandas.DataFrame.html">DataFrame</a>. Panels are 3-D structures, which is great for this kind of data. The three dimensions are</p>
<ol>
<li>items: Month in Survey (0 - 7)</li>
<li>fields: Things like employment status, earnings, hours worked</li>
<li>id: An identifier for each household</li>
</ol>
<p>Think of each item as a 2-D slice (a DataFrame) into the 3-D Panel. So each household is described by a single Panel (or 8 DataFrames).</p>
<p>The actual panel construction occurs in <a href="https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_panel.py#L151"><code>make_full_panel</code></a>. Given a starting month, it figures out the months needed to generate that wave's Panel ($m, m + 1, m + 2, \ldots$), and stores these in an iterator called <code>dfs</code>.
Since each month on disk contains people from 8 different waves (first month, second month, ...), I filter down to just the people in their $i^{th}$ month in the survey, where $i$ is the month I'm interested in.
Everything up until this point is done lazily; nothing has actually be read into memory yet.</p>
<p>Now we'll read in each month, storing each month's DataFrame in a dictionary, <code>df_dict</code>. We take the first month as is.
Each subsequent month has to be matched against the first month.</p>
<pre class="code literal-block">    <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">df1</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dfn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">df_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_panel</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">dfn</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">'panel_log'</span><span class="p">])</span>
    <span class="c"># Lose dtype info here if I just do from dict.</span>
    <span class="c"># to preserve dtypes:</span>
    <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">}</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Panel</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">df_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s">'minor'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wp</span>
</pre>


<p>In an ideal world, we just check to see if the indexes match (the unique identifier). However, the unique ID given by the Census Bureau isn't so unique, so we use some heuristics to guess if the person is actually the same as the one interviewed next week. <code>match_panel</code> basically checks to see if a person's race and gender hasn't changed, and that their age has changed by less than a year or so.</p>
<p>There's a bit more code that handles special cases, errors, and the writing of the output.
I was especially interested in earnings data, so I wrote that out separately.
But now we're finally to the point where we can do some analysis:</p>
</div>
        </div>
                <ul class="pager">
            <li class="previous">
                <a href="tackling%20the%20cps%20(part%203).html" rel="prev" title="Using Python to tackle the CPS (Part 3)">Previous post</a>
            </li>
            <li class="next">
                <a href="setting-up.html" rel="next" title="Setting Up">Next post</a>
            </li>
        </ul>

    </div>
                    <footer id="footer" role="contentinfo">
            <p>Contents © 2015         <a href="mailto:tom.w.augspurger@gmail.com">Tom Augspurger</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>

        </div>
    </section>
    
    
                <script src="../assets/js/all-nocdn.js" type="text/javascript"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


        <script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
