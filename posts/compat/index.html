<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tom's Blog</title><meta name=keywords content><meta name=description content="Title: Compatibility Code Date: 2019-12-12 Slug: compatibility status: draft
Compatibility Code Most libraries with dependencies will want to support multiple versions of that dependency. But supporting old version is a pain: it requires compatibility code, code that is around solely to get the same output from versions of a library. This post gives some advice on writing compatibility code.
Don&rsquo;t write your own version parser Centralize all version parsing Use consistent version comparisons Use Python&rsquo;s argument unpacking Clean up unused compatibility code 1."><meta name=author content><link rel=canonical href=https://tomaugspurger.github.io/posts/compat/><link crossorigin=anonymous href=/assets/css/stylesheet.67b4a5a78be69ca812d40e5543fbd83efd0b0cc5025c2505fd7758fd5d32ec2e.css integrity="sha256-Z7Slp4vmnKgS1A5VQ/vYPv0LDMUCXCUF/XdY/V0y7C4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://tomaugspurger.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tomaugspurger.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tomaugspurger.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tomaugspurger.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tomaugspurger.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content><meta property="og:description" content="Title: Compatibility Code Date: 2019-12-12 Slug: compatibility status: draft
Compatibility Code Most libraries with dependencies will want to support multiple versions of that dependency. But supporting old version is a pain: it requires compatibility code, code that is around solely to get the same output from versions of a library. This post gives some advice on writing compatibility code.
Don&rsquo;t write your own version parser Centralize all version parsing Use consistent version comparisons Use Python&rsquo;s argument unpacking Clean up unused compatibility code 1."><meta property="og:type" content="article"><meta property="og:url" content="https://tomaugspurger.github.io/posts/compat/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Title: Compatibility Code Date: 2019-12-12 Slug: compatibility status: draft
Compatibility Code Most libraries with dependencies will want to support multiple versions of that dependency. But supporting old version is a pain: it requires compatibility code, code that is around solely to get the same output from versions of a library. This post gives some advice on writing compatibility code.
Don&rsquo;t write your own version parser Centralize all version parsing Use consistent version comparisons Use Python&rsquo;s argument unpacking Clean up unused compatibility code 1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://tomaugspurger.github.io/posts/"},{"@type":"ListItem","position":3,"name":"","item":"https://tomaugspurger.github.io/posts/compat/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"Title: Compatibility Code Date: 2019-12-12 Slug: compatibility status: draft\nCompatibility Code Most libraries with dependencies will want to support multiple versions of that dependency. But supporting old version is a pain: it requires compatibility code, code that is around solely to get the same output from versions of a library. This post gives some advice on writing compatibility code.\nDon\u0026rsquo;t write your own version parser Centralize all version parsing Use consistent version comparisons Use Python\u0026rsquo;s argument unpacking Clean up unused compatibility code 1.","keywords":[],"articleBody":"Title: Compatibility Code Date: 2019-12-12 Slug: compatibility status: draft\nCompatibility Code Most libraries with dependencies will want to support multiple versions of that dependency. But supporting old version is a pain: it requires compatibility code, code that is around solely to get the same output from versions of a library. This post gives some advice on writing compatibility code.\nDon’t write your own version parser Centralize all version parsing Use consistent version comparisons Use Python’s argument unpacking Clean up unused compatibility code 1. Don’t write your own version parser It can be tempting just do something like\nif pandas.__version__.split(\".\")[1] \u003e= \"25\": ... But that’s probably going to break, sometimes in unexpected ways. Use either distutils.version.LooseVersion or packaging.version.parse which handles all the edge cases.\nPANDAS_VERSION = LooseVersion(pandas.__version__) 2. Centralize all version parsing in a _compat.py file The first section of compatibility code is typically a version check. It can be tempting to do the version-check inline with the compatibility code\nif LooseVersion(pandas.__version__) \u003e= \"0.25.0\": return pandas.concat(args, sort=False) else: return pandas.concat(args) Rather than that, I recommend centralizing the version checks in a central _compat.py file that defines constants for each library version you need compatibility code for.\n# library/_compat.py import pandas PANDAS_VERSION = LooseVersion(pandas.__version__) PANDAS_0240 = PANDAS_VERSION \u003e= \"0.24.0 PANDAS_0250 = PANDAS_VERSION \u003e= \"0.25.0 This, combined with item 3, will make it easier to clean up your code (see below).\n3. Use consistent version comparisons Notice that I defined constants for each pandas version, PANDAS_0240, PANDAS_0250. Those mean “the installed version of pandas is at least this version”, since I used the \u003e= comparison. You could instead define constants like\nPANDAS_LT_0240 = PANDAS_VERSION \u003c \"0.24.0\" That works too, just ensure that you’re consistent.\n4. Use Python’s argument unpacking Python’s argument unpacking helps avoid code duplication when the signature of a function changes.\nparam_grid = {\"estimator__alpha\": [0.1, 10]} if SK_022: kwargs = {} else: kwargs = {\"iid\": False} gs = sklearn.model_selection.GridSearchCV(clf, param_grid, cv=3, **kwargs) Using *args, and **kwargs to pass through version-dependent arguments lets you have just a single call to the callable when the only difference is the arguments passed.\n5. Clean up unused compatibility code Actively developed libraries may eventually drop support for old versions of dependency libraries. At a minimum, this involves removing the old version from your test matrix and bumping your required version in your dependency list. But ideally you would also clean up the now-unused compatibility code. The strategies laid out here intend to make that as easy as possible.\nConsider the following.\n# library/core.py import pandas from ._comapt import PANDAS_0250 def f(args): ... if PANDAS_0250: return pandas.concat(args, sort=False) else: return pandas.concat(args) Now suppose it’s the future and we want to drop support for pandas older than 0.25.x Now all the conditions checking if PANDAS_0250 are automatically true, so we’d\nDelete PANDAS_0250 from _compat.py Remove the import in core.py Remove the if PANDAS_0250 check, and always have the True part of that condition # library/core.py import pandas def f(args): ... return pandas.concat(args, sort=False) I acknowledge that indirection can harm readability. In this case I think it’s warranted for actively maintained projects. Using inline version checks, perhaps with inconsistent comparisons, will make it harder to know when code is now unused. When integrated over the lifetime of the project, I find the strategies laid out here more readable.\n","wordCount":"550","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tomaugspurger.github.io/posts/compat/"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://tomaugspurger.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tomaugspurger.github.io accesskey=h title="Tom's Blog (Alt + H)">Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tomaugspurger.github.io/about/ title=About><span>About</span></a></li><li><a href=https://tomaugspurger.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://tomaugspurger.github.io/index.xml title=RSS><span>RSS</span></a></li><li><a href=https://tomaugspurger.github.io/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title></h1><div class=post-meta></div></header><div class=post-content><p>Title: Compatibility Code
Date: 2019-12-12
Slug: compatibility
status: draft</p><h1 id=compatibility-code>Compatibility Code<a hidden class=anchor aria-hidden=true href=#compatibility-code>#</a></h1><p>Most libraries with dependencies will want to support multiple versions
of that dependency. But supporting old version is a pain: it requires <em>compatibility code</em>,
code that is around solely to get the same output from versions of a library. This post
gives some advice on writing compatibility code.</p><ol><li>Don&rsquo;t write your own version parser</li><li>Centralize all version parsing</li><li>Use consistent version comparisons</li><li>Use Python&rsquo;s argument unpacking</li><li>Clean up unused compatibility code</li></ol><h2 id=1-dont-write-your-own-version-parser>1. Don&rsquo;t write your own version parser<a hidden class=anchor aria-hidden=true href=#1-dont-write-your-own-version-parser>#</a></h2><p>It can be tempting just do something like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> pandas<span style=color:#f92672>.</span>__version__<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;.&#34;</span>)[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#34;25&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>But that&rsquo;s probably going to break, sometimes in unexpected ways. Use either <code>distutils.version.LooseVersion</code>
or <code>packaging.version.parse</code> which handles all the edge cases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>PANDAS_VERSION <span style=color:#f92672>=</span> LooseVersion(pandas<span style=color:#f92672>.</span>__version__)
</span></span></code></pre></div><h2 id=2-centralize-all-version-parsing-in-a-_compatpy-file>2. Centralize all version parsing in a <code>_compat.py</code> file<a hidden class=anchor aria-hidden=true href=#2-centralize-all-version-parsing-in-a-_compatpy-file>#</a></h2><p>The first section of compatibility code is typically a version check. It can be tempting
to do the version-check inline with the compatibility code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> LooseVersion(pandas<span style=color:#f92672>.</span>__version__) <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#34;0.25.0&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pandas<span style=color:#f92672>.</span>concat(args, sort<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pandas<span style=color:#f92672>.</span>concat(args)
</span></span></code></pre></div><p>Rather than that, I recommend centralizing the version checks in a central <code>_compat.py</code> file
that defines constants for each library version you need compatibility code for.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># library/_compat.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PANDAS_VERSION <span style=color:#f92672>=</span> LooseVersion(pandas<span style=color:#f92672>.</span>__version__)
</span></span><span style=display:flex><span>PANDAS_0240 <span style=color:#f92672>=</span> PANDAS_VERSION <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#34;0.24.0</span>
</span></span><span style=display:flex><span>PANDAS_0250 <span style=color:#f92672>=</span> PANDAS_VERSION <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#34;0.25.0</span>
</span></span></code></pre></div><p>This, combined with item 3, will make it easier to clean up your code (see below).</p><h2 id=3-use-consistent-version-comparisons>3. Use consistent version comparisons<a hidden class=anchor aria-hidden=true href=#3-use-consistent-version-comparisons>#</a></h2><p>Notice that I defined constants for each pandas version, <code>PANDAS_0240</code>,
<code>PANDAS_0250</code>. Those mean &ldquo;the installed version of pandas is at least this
version&rdquo;, since I used the <code>>=</code> comparison. You could instead define constants
like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>PANDAS_LT_0240 <span style=color:#f92672>=</span> PANDAS_VERSION <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#34;0.24.0&#34;</span>
</span></span></code></pre></div><p>That works too, just ensure that you&rsquo;re consistent.</p><h2 id=4-use-pythons-argument-unpacking>4. Use Python&rsquo;s argument unpacking<a hidden class=anchor aria-hidden=true href=#4-use-pythons-argument-unpacking>#</a></h2><p>Python&rsquo;s <a href=https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists>argument unpacking</a> helps avoid code duplication when the
signature of a function changes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    param_grid <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;estimator__alpha&#34;</span>: [<span style=color:#ae81ff>0.1</span>, <span style=color:#ae81ff>10</span>]}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> SK_022:
</span></span><span style=display:flex><span>        kwargs <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        kwargs <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;iid&#34;</span>: <span style=color:#66d9ef>False</span>}
</span></span><span style=display:flex><span>    gs <span style=color:#f92672>=</span> sklearn<span style=color:#f92672>.</span>model_selection<span style=color:#f92672>.</span>GridSearchCV(clf, param_grid, cv<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, <span style=color:#f92672>**</span>kwargs)
</span></span></code></pre></div><p>Using <code>*args</code>, and <code>**kwargs</code> to pass through version-dependent arguments lets you
have just a single call to the callable when the only difference is the
arguments passed.</p><h2 id=5-clean-up-unused-compatibility-code>5. Clean up unused compatibility code<a hidden class=anchor aria-hidden=true href=#5-clean-up-unused-compatibility-code>#</a></h2><p>Actively developed libraries may eventually drop support for old versions
of dependency libraries. At a minimum, this involves removing the old version
from your test matrix and bumping your required version in your dependency list.
But ideally you would also clean up the now-unused compatibility code. The
strategies laid out here intend to make that as easy as possible.</p><p>Consider the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># library/core.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ._comapt <span style=color:#f92672>import</span> PANDAS_0250
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(args):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> PANDAS_0250:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> pandas<span style=color:#f92672>.</span>concat(args, sort<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> pandas<span style=color:#f92672>.</span>concat(args)
</span></span></code></pre></div><p>Now suppose it&rsquo;s the future and we want to drop support for pandas older than 0.25.x
Now all the conditions checking <code>if PANDAS_0250</code> are automatically true, so we&rsquo;d</p><ol><li>Delete <code>PANDAS_0250</code> from <code>_compat.py</code></li><li>Remove the import in <code>core.py</code></li><li>Remove the <code>if PANDAS_0250</code> check, and always have the True part of that
condition</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># library/core.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(args):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pandas<span style=color:#f92672>.</span>concat(args, sort<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span></code></pre></div><p>I acknowledge that <a href=https://matthewrocklin.com/blog/work/2019/06/23/avoid-indirection>indirection can harm readability</a>. In this case
I think it&rsquo;s warranted for actively maintained projects. Using inline version
checks, perhaps with inconsistent comparisons, will make it harder to know when
code is now unused. When integrated over the lifetime of the project, I find the
strategies laid out here more readable.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://tomaugspurger.github.io>Tom's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><a rel=me href=https://mastodon.social/@TomAugspurger></a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>