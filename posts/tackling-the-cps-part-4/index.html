<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Python to tackle the CPS (Part 4) | Tom's Blog</title><meta name=keywords content="pandas"><meta name=description content="Last time, we got to where we&rsquo;d like to have started: One file per month, with each month laid out the same.
As a reminder, the CPS interviews households 8 times over the course of 16 months. They&rsquo;re interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you&rsquo;re also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$."><meta name=author content><link rel=canonical href=https://tomaugspurger.github.io/posts/tackling-the-cps-part-4/><link crossorigin=anonymous href=/assets/css/stylesheet.67b4a5a78be69ca812d40e5543fbd83efd0b0cc5025c2505fd7758fd5d32ec2e.css integrity="sha256-Z7Slp4vmnKgS1A5VQ/vYPv0LDMUCXCUF/XdY/V0y7C4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://tomaugspurger.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tomaugspurger.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tomaugspurger.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tomaugspurger.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tomaugspurger.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Using Python to tackle the CPS (Part 4)"><meta property="og:description" content="Last time, we got to where we&rsquo;d like to have started: One file per month, with each month laid out the same.
As a reminder, the CPS interviews households 8 times over the course of 16 months. They&rsquo;re interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you&rsquo;re also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$."><meta property="og:type" content="article"><meta property="og:url" content="https://tomaugspurger.github.io/posts/tackling-the-cps-part-4/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Python to tackle the CPS (Part 4)"><meta name=twitter:description content="Last time, we got to where we&rsquo;d like to have started: One file per month, with each month laid out the same.
As a reminder, the CPS interviews households 8 times over the course of 16 months. They&rsquo;re interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you&rsquo;re also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://tomaugspurger.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Using Python to tackle the CPS (Part 4)","item":"https://tomaugspurger.github.io/posts/tackling-the-cps-part-4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Python to tackle the CPS (Part 4)","name":"Using Python to tackle the CPS (Part 4)","description":"Last time, we got to where we\u0026rsquo;d like to have started: One file per month, with each month laid out the same.\nAs a reminder, the CPS interviews households 8 times over the course of 16 months. They\u0026rsquo;re interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you\u0026rsquo;re also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$.","keywords":["pandas"],"articleBody":"Last time, we got to where we’d like to have started: One file per month, with each month laid out the same.\nAs a reminder, the CPS interviews households 8 times over the course of 16 months. They’re interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you’re also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$.\nI stored the data in Panels, the less well-known, higher-dimensional cousin of the DataFrame. Panels are 3-D structures, which is great for this kind of data. The three dimensions are\nitems: Month in Survey (0 - 7) fields: Things like employment status, earnings, hours worked id: An identifier for each household Think of each item as a 2-D slice (a DataFrame) into the 3-D Panel. So each household is described by a single Panel (or 8 DataFrames).\nThe actual panel construction occurs in make_full_panel. Given a starting month, it figures out the months needed to generate that wave’s Panel ($m, m + 1, m + 2, \\ldots$), and stores these in an iterator called dfs. Since each month on disk contains people from 8 different waves (first month, second month, …), I filter down to just the people in their $i^{th}$ month in the survey, where $i$ is the month I’m interested in. Everything up until this point is done lazily; nothing has actually be read into memory yet.\nNow we’ll read in each month, storing each month’s DataFrame in a dictionary, df_dict. We take the first month as is. Each subsequent month has to be matched against the first month.\ndf_dict = {1: df1} for i, dfn in enumerate(dfs, 2): df_dict[i] = match_panel(df1, dfn, log=settings['panel_log']) # Lose dtype info here if I just do from dict. # to preserve dtypes: df_dict = {k: v for k, v in df_dict.iteritems() if v is not None} wp = pd.Panel.from_dict(df_dict, orient='minor') return wp In an ideal world, we just check to see if the indexes match (the unique identifier). However, the unique ID given by the Census Bureau isn’t so unique, so we use some heuristics to guess if the person is actually the same as the one interviewed next week. match_panel basically checks to see if a person’s race and gender hasn’t changed, and that their age has changed by less than a year or so.\nThere’s a bit more code that handles special cases, errors, and the writing of the output. I was especially interested in earnings data, so I wrote that out separately. But now we’re finally to the point where we can do some analysis:\n","wordCount":"454","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tomaugspurger.github.io/posts/tackling-the-cps-part-4/"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://tomaugspurger.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tomaugspurger.github.io accesskey=h title="Tom's Blog (Alt + H)">Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tomaugspurger.github.io/about/ title=About><span>About</span></a></li><li><a href=https://tomaugspurger.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://tomaugspurger.github.io/index.xml title=RSS><span>RSS</span></a></li><li><a href=https://tomaugspurger.github.io/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using Python to tackle the CPS (Part 4)</h1><div class=post-meta></div></header><div class=post-content><p>Last time, we got to where we&rsquo;d like to have started: One file per month, with each month laid out the same.</p><p>As a reminder, the CPS interviews households 8 times over the course of 16 months. They&rsquo;re interviewed for 4 months, take 8 months off, and are interviewed four more times. So if your first interview was in month $m$, you&rsquo;re also interviewed in months $$m + 1, m + 2, m + 3, m + 12, m + 13, m + 14, m + 15$$.</p><p>I stored the data in <a href=http://pandas-docs.github.io/pandas-docs-travis/dsintro.html#panel>Panels</a>, the less well-known, higher-dimensional cousin of the <a href=http://pandas.pydata.org/pandas-docs/version/0.13.1/generated/pandas.DataFrame.html>DataFrame</a>. Panels are 3-D structures, which is great for this kind of data. The three dimensions are</p><ol><li>items: Month in Survey (0 - 7)</li><li>fields: Things like employment status, earnings, hours worked</li><li>id: An identifier for each household</li></ol><p>Think of each item as a 2-D slice (a DataFrame) into the 3-D Panel. So each household is described by a single Panel (or 8 DataFrames).</p><p>The actual panel construction occurs in <a href=https://github.com/TomAugspurger/dnwr-zlb/blob/master/data_wrangling/cps_wrangling/panel_construction/make_panel.py#L151><code>make_full_panel</code></a>. Given a starting month, it figures out the months needed to generate that wave&rsquo;s Panel ($m, m + 1, m + 2, \ldots$), and stores these in an iterator called <code>dfs</code>.
Since each month on disk contains people from 8 different waves (first month, second month, &mldr;), I filter down to just the people in their $i^{th}$ month in the survey, where $i$ is the month I&rsquo;m interested in.
Everything up until this point is done lazily; nothing has actually be read into memory yet.</p><p>Now we&rsquo;ll read in each month, storing each month&rsquo;s DataFrame in a dictionary, <code>df_dict</code>. We take the first month as is.
Each subsequent month has to be matched against the first month.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    df_dict <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: df1}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i, dfn <span style=color:#f92672>in</span> enumerate(dfs, <span style=color:#ae81ff>2</span>):
</span></span><span style=display:flex><span>        df_dict[i] <span style=color:#f92672>=</span> match_panel(df1, dfn, log<span style=color:#f92672>=</span>settings[<span style=color:#e6db74>&#39;panel_log&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#75715e># Lose dtype info here if I just do from dict.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># to preserve dtypes:</span>
</span></span><span style=display:flex><span>    df_dict <span style=color:#f92672>=</span> {k: v <span style=color:#66d9ef>for</span> k, v <span style=color:#f92672>in</span> df_dict<span style=color:#f92672>.</span>iteritems() <span style=color:#66d9ef>if</span> v <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>}
</span></span><span style=display:flex><span>    wp <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>Panel<span style=color:#f92672>.</span>from_dict(df_dict, orient<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;minor&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wp
</span></span></code></pre></div><p>In an ideal world, we just check to see if the indexes match (the unique identifier). However, the unique ID given by the Census Bureau isn&rsquo;t so unique, so we use some heuristics to guess if the person is actually the same as the one interviewed next week. <code>match_panel</code> basically checks to see if a person&rsquo;s race and gender hasn&rsquo;t changed, and that their age has changed by less than a year or so.</p><p>There&rsquo;s a bit more code that handles special cases, errors, and the writing of the output.
I was especially interested in earnings data, so I wrote that out separately.
But now we&rsquo;re finally to the point where we can do some analysis:</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tomaugspurger.github.io/tags/pandas/>pandas</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://tomaugspurger.github.io>Tom's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>