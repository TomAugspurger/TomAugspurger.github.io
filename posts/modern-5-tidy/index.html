<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Modern Pandas (Part 5): Tidy Data | Tom's Blog</title>
<meta name=keywords content="pandas"><meta name=description content="This is part 5 in my series on writing modern idiomatic pandas.
Modern Pandas Method Chaining Indexes Fast Pandas Tidy Data Visualization Time Series Scaling Reshaping & Tidy Data Structuring datasets to facilitate analysis (Wickham 2014)
So, you&rsquo;ve sat down to analyze a new dataset. What do you do first?
In episode 11 of Not So Standard Deviations, Hilary and Roger discussed their typical approaches. I&rsquo;m with Hilary on this one, you should make sure your data is tidy."><meta name=author content><link rel=canonical href=https://tomaugspurger.net/posts/modern-5-tidy/><link crossorigin=anonymous href=/assets/css/stylesheet.3690c96d8a707265a16abd3b389bb33e4e3916869c3142cba43a3cfaaed4b5f9.css integrity="sha256-NpDJbYpwcmWhar07OJuzPk45FoacMULLpDo8+q7Utfk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://tomaugspurger.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tomaugspurger.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tomaugspurger.net/favicon-32x32.png><link rel=apple-touch-icon href=https://tomaugspurger.net/apple-touch-icon.png><link rel=mask-icon href=https://tomaugspurger.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Modern Pandas (Part 5): Tidy Data"><meta property="og:description" content="This is part 5 in my series on writing modern idiomatic pandas.
Modern Pandas Method Chaining Indexes Fast Pandas Tidy Data Visualization Time Series Scaling Reshaping & Tidy Data Structuring datasets to facilitate analysis (Wickham 2014)
So, you&rsquo;ve sat down to analyze a new dataset. What do you do first?
In episode 11 of Not So Standard Deviations, Hilary and Roger discussed their typical approaches. I&rsquo;m with Hilary on this one, you should make sure your data is tidy."><meta property="og:type" content="article"><meta property="og:url" content="https://tomaugspurger.net/posts/modern-5-tidy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-04-22T00:00:00+00:00"><meta property="article:modified_time" content="2016-04-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Modern Pandas (Part 5): Tidy Data"><meta name=twitter:description content="This is part 5 in my series on writing modern idiomatic pandas.
Modern Pandas Method Chaining Indexes Fast Pandas Tidy Data Visualization Time Series Scaling Reshaping & Tidy Data Structuring datasets to facilitate analysis (Wickham 2014)
So, you&rsquo;ve sat down to analyze a new dataset. What do you do first?
In episode 11 of Not So Standard Deviations, Hilary and Roger discussed their typical approaches. I&rsquo;m with Hilary on this one, you should make sure your data is tidy."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://tomaugspurger.net/posts/"},{"@type":"ListItem","position":3,"name":"Modern Pandas (Part 5): Tidy Data","item":"https://tomaugspurger.net/posts/modern-5-tidy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Modern Pandas (Part 5): Tidy Data","name":"Modern Pandas (Part 5): Tidy Data","description":"This is part 5 in my series on writing modern idiomatic pandas.\nModern Pandas Method Chaining Indexes Fast Pandas Tidy Data Visualization Time Series Scaling Reshaping \u0026amp; Tidy Data Structuring datasets to facilitate analysis (Wickham 2014)\nSo, you\u0026rsquo;ve sat down to analyze a new dataset. What do you do first?\nIn episode 11 of Not So Standard Deviations, Hilary and Roger discussed their typical approaches. I\u0026rsquo;m with Hilary on this one, you should make sure your data is tidy.","keywords":["pandas"],"articleBody":" This is part 5 in my series on writing modern idiomatic pandas.\nModern Pandas Method Chaining Indexes Fast Pandas Tidy Data Visualization Time Series Scaling Reshaping \u0026 Tidy Data Structuring datasets to facilitate analysis (Wickham 2014)\nSo, you’ve sat down to analyze a new dataset. What do you do first?\nIn episode 11 of Not So Standard Deviations, Hilary and Roger discussed their typical approaches. I’m with Hilary on this one, you should make sure your data is tidy. Before you do any plots, filtering, transformations, summary statistics, regressions… Without a tidy dataset, you’ll be fighting your tools to get the result you need. With a tidy dataset, it’s relatively easy to do all of those.\nHadley Wickham kindly summarized tidiness as a dataset where\nEach variable forms a column Each observation forms a row Each type of observational unit forms a table And today we’ll only concern ourselves with the first two. As quoted at the top, this really is about facilitating analysis: going as quickly as possible from question to answer.\n%matplotlib inline import os import numpy as np import pandas as pd import seaborn as sns import matplotlib.pyplot as plt if int(os.environ.get(\"MODERN_PANDAS_EPUB\", 0)): import prep # noqa pd.options.display.max_rows = 10 sns.set(style='ticks', context='talk') NBA Data This StackOverflow question asked about calculating the number of days of rest NBA teams have between games. The answer would have been difficult to compute with the raw data. After transforming the dataset to be tidy, we’re able to quickly get the answer.\nWe’ll grab some NBA game data from basketball-reference.com using pandas’ read_html function, which returns a list of DataFrames.\nfp = 'data/nba.csv' if not os.path.exists(fp): tables = pd.read_html(\"http://www.basketball-reference.com/leagues/NBA_2016_games.html\") games = tables[0] games.to_csv(fp) else: games = pd.read_csv(fp) games.head() Date Start (ET) Unnamed: 2 Visitor/Neutral PTS Home/Neutral PTS.1 Unnamed: 7 Notes 0 October NaN NaN NaN NaN NaN NaN NaN NaN 1 Tue, Oct 27, 2015 8:00 pm Box Score Detroit Pistons 106.0 Atlanta Hawks 94.0 NaN NaN 2 Tue, Oct 27, 2015 8:00 pm Box Score Cleveland Cavaliers 95.0 Chicago Bulls 97.0 NaN NaN 3 Tue, Oct 27, 2015 10:30 pm Box Score New Orleans Pelicans 95.0 Golden State Warriors 111.0 NaN NaN 4 Wed, Oct 28, 2015 7:30 pm Box Score Philadelphia 76ers 95.0 Boston Celtics 112.0 NaN NaN Side note: pandas’ read_html is pretty good. On simple websites it almost always works. It provides a couple parameters for controlling what gets selected from the webpage if the defaults fail. I’ll always use it first, before moving on to BeautifulSoup or lxml if the page is more complicated.\nAs you can see, we have a bit of general munging to do before tidying. Each month slips in an extra row of mostly NaNs, the column names aren’t too useful, and we have some dtypes to fix up.\ncolumn_names = {'Date': 'date', 'Start (ET)': 'start', 'Unamed: 2': 'box', 'Visitor/Neutral': 'away_team', 'PTS': 'away_points', 'Home/Neutral': 'home_team', 'PTS.1': 'home_points', 'Unamed: 7': 'n_ot'} games = (games.rename(columns=column_names) .dropna(thresh=4) [['date', 'away_team', 'away_points', 'home_team', 'home_points']] .assign(date=lambda x: pd.to_datetime(x['date'], format='%a, %b %d, %Y')) .set_index('date', append=True) .rename_axis([\"game_id\", \"date\"]) .sort_index()) games.head() away_team away_points home_team home_points game_id date 1 2015-10-27 Detroit Pistons 106.0 Atlanta Hawks 94.0 2 2015-10-27 Cleveland Cavaliers 95.0 Chicago Bulls 97.0 3 2015-10-27 New Orleans Pelicans 95.0 Golden State Warriors 111.0 4 2015-10-28 Philadelphia 76ers 95.0 Boston Celtics 112.0 5 2015-10-28 Chicago Bulls 115.0 Brooklyn Nets 100.0 A quick aside on that last block.\ndropna has a thresh argument. If at least thresh items are missing, the row is dropped. We used it to remove the “Month headers” that slipped into the table. assign can take a callable. This lets us refer to the DataFrame in the previous step of the chain. Otherwise we would have to assign temp_df = games.dropna()... And then do the pd.to_datetime on that. set_index has an append keyword. We keep the original index around since it will be our unique identifier per game. We use .rename_axis to set the index names (this behavior is new in pandas 0.18; before .rename_axis only took a mapping for changing labels). The Question:\nHow many days of rest did each team get between each game?\nWhether or not your dataset is tidy depends on your question. Given our question, what is an observation?\nIn this case, an observation is a (team, game) pair, which we don’t have yet. Rather, we have two observations per row, one for home and one for away. We’ll fix that with pd.melt.\npd.melt works by taking observations that are spread across columns (away_team, home_team), and melting them down into one column with multiple rows. However, we don’t want to lose the metadata (like game_id and date) that is shared between the observations. By including those columns as id_vars, the values will be repeated as many times as needed to stay with their observations.\ntidy = pd.melt(games.reset_index(), id_vars=['game_id', 'date'], value_vars=['away_team', 'home_team'], value_name='team') tidy.head() game_id date variable team 0 1 2015-10-27 away_team Detroit Pistons 1 2 2015-10-27 away_team Cleveland Cavaliers 2 3 2015-10-27 away_team New Orleans Pelicans 3 4 2015-10-28 away_team Philadelphia 76ers 4 5 2015-10-28 away_team Chicago Bulls The DataFrame tidy meets our rules for tidiness: each variable is in a column, and each observation (team, date pair) is on its own row. Now the translation from question (“How many days of rest between games”) to operation (“date of today’s game - date of previous game - 1”) is direct:\n# For each team... get number of days between games tidy.groupby('team')['date'].diff().dt.days - 1 0 NaN 1 NaN 2 NaN 3 NaN 4 NaN ... 2455 7.0 2456 1.0 2457 1.0 2458 3.0 2459 2.0 Name: date, Length: 2460, dtype: float64 That’s the essence of tidy data, the reason why it’s worth considering what shape your data should be in. It’s about setting yourself up for success so that the answers naturally flow from the data (just kidding, it’s usually still difficult. But hopefully less so).\nLet’s assign that back into our DataFrame\ntidy['rest'] = tidy.sort_values('date').groupby('team').date.diff().dt.days - 1 tidy.dropna().head() game_id date variable team rest 4 5 2015-10-28 away_team Chicago Bulls 0.0 8 9 2015-10-28 away_team Cleveland Cavaliers 0.0 14 15 2015-10-28 away_team New Orleans Pelicans 0.0 17 18 2015-10-29 away_team Memphis Grizzlies 0.0 18 19 2015-10-29 away_team Dallas Mavericks 0.0 To show the inverse of melt, let’s take rest values we just calculated and place them back in the original DataFrame with a pivot_table.\nby_game = (pd.pivot_table(tidy, values='rest', index=['game_id', 'date'], columns='variable') .rename(columns={'away_team': 'away_rest', 'home_team': 'home_rest'})) df = pd.concat([games, by_game], axis=1) df.dropna().head() away_team away_points home_team home_points away_rest home_rest game_id date 18 2015-10-29 Memphis Grizzlies 112.0 Indiana Pacers 103.0 0.0 0.0 19 2015-10-29 Dallas Mavericks 88.0 Los Angeles Clippers 104.0 0.0 0.0 20 2015-10-29 Atlanta Hawks 112.0 New York Knicks 101.0 1.0 0.0 21 2015-10-30 Charlotte Hornets 94.0 Atlanta Hawks 97.0 1.0 0.0 22 2015-10-30 Toronto Raptors 113.0 Boston Celtics 103.0 1.0 1.0 One somewhat subtle point: an “observation” depends on the question being asked. So really, we have two tidy datasets, tidy for answering team-level questions, and df for answering game-level questions.\nOne potentially interesting question is “what was each team’s average days of rest, at home and on the road?” With a tidy dataset (the DataFrame tidy, since it’s team-level), seaborn makes this easy (more on seaborn in a future post):\nsns.set(style='ticks', context='paper') g = sns.FacetGrid(tidy, col='team', col_wrap=6, hue='team', size=2) g.map(sns.barplot, 'variable', 'rest'); An example of a game-level statistic is the distribution of rest differences in games:\ndf['home_win'] = df['home_points'] \u003e df['away_points'] df['rest_spread'] = df['home_rest'] - df['away_rest'] df.dropna().head() away_team away_points home_team home_points away_rest home_rest home_win rest_spread game_id date 18 2015-10-29 Memphis Grizzlies 112.0 Indiana Pacers 103.0 0.0 0.0 False 0.0 19 2015-10-29 Dallas Mavericks 88.0 Los Angeles Clippers 104.0 0.0 0.0 True 0.0 20 2015-10-29 Atlanta Hawks 112.0 New York Knicks 101.0 1.0 0.0 False -1.0 21 2015-10-30 Charlotte Hornets 94.0 Atlanta Hawks 97.0 1.0 0.0 True -1.0 22 2015-10-30 Toronto Raptors 113.0 Boston Celtics 103.0 1.0 1.0 False 0.0 delta = (by_game.home_rest - by_game.away_rest).dropna().astype(int) ax = (delta.value_counts() .reindex(np.arange(delta.min(), delta.max() + 1), fill_value=0) .sort_index() .plot(kind='bar', color='k', width=.9, rot=0, figsize=(12, 6)) ) sns.despine() ax.set(xlabel='Difference in Rest (Home - Away)', ylabel='Games'); Or the win percent by rest difference\nfig, ax = plt.subplots(figsize=(12, 6)) sns.barplot(x='rest_spread', y='home_win', data=df.query('-3 \u003c= rest_spread \u003c= 3'), color='#4c72b0', ax=ax) sns.despine() Stack / Unstack Pandas has two useful methods for quickly converting from wide to long format (stack) and long to wide (unstack).\nrest = (tidy.groupby(['date', 'variable']) .rest.mean() .dropna()) rest.head() date variable 2015-10-28 away_team 0.000000 home_team 0.000000 2015-10-29 away_team 0.333333 home_team 0.000000 2015-10-30 away_team 1.083333 Name: rest, dtype: float64 rest is in a “long” form since we have a single column of data, with multiple “columns” of metadata (in the MultiIndex). We use .unstack to move from long to wide.\nrest.unstack().head() variable away_team home_team date 2015-10-28 0.000000 0.000000 2015-10-29 0.333333 0.000000 2015-10-30 1.083333 0.916667 2015-10-31 0.166667 0.833333 2015-11-01 1.142857 1.000000 unstack moves a level of a MultiIndex (innermost by default) up to the columns. stack is the inverse.\nrest.unstack().stack() date variable 2015-10-28 away_team 0.000000 home_team 0.000000 2015-10-29 away_team 0.333333 home_team 0.000000 2015-10-30 away_team 1.083333 ... 2016-04-11 home_team 0.666667 2016-04-12 away_team 1.000000 home_team 1.400000 2016-04-13 away_team 0.500000 home_team 1.214286 Length: 320, dtype: float64 With .unstack you can move between those APIs that expect there data in long-format and those APIs that work with wide-format data. For example, DataFrame.plot(), works with wide-form data, one line per column.\nwith sns.color_palette() as pal: b, g = pal.as_hex()[:2] ax=(rest.unstack() .query('away_team \u003c 7') .rolling(7) .mean() .plot(figsize=(12, 6), linewidth=3, legend=False)) ax.set(ylabel='Rest (7 day MA)') ax.annotate(\"Home\", (rest.index[-1][0], 1.02), color=g, size=14) ax.annotate(\"Away\", (rest.index[-1][0], 0.82), color=b, size=14) sns.despine() The most conenient form will depend on exactly what you’re doing. When interacting with databases you’ll often deal with long form data. Pandas’ DataFrame.plot often expects wide-form data, while seaborn often expect long-form data. Regressions will expect wide-form data. Either way, it’s good to be comfortable with stack and unstack (and MultiIndexes) to quickly move between the two.\nMini Project: Home Court Advantage? We’ve gone to all that work tidying our dataset, let’s put it to use. What’s the effect (in terms of probability to win) of being the home team?\nStep 1: Create an outcome variable We need to create an indicator for whether the home team won. Add it as a column called home_win in games.\ndf['home_win'] = df.home_points \u003e df.away_points Step 2: Find the win percent for each team In the 10-minute literature review I did on the topic, it seems like people include a team-strength variable in their regressions. I suppose that makes sense; if stronger teams happened to play against weaker teams at home more often than away, it’d look like the home-effect is stronger than it actually is. We’ll do a terrible job of controlling for team strength by calculating each team’s win percent and using that as a predictor. It’d be better to use some kind of independent measure of team strength, but this will do for now.\nWe’ll use a similar melt operation as earlier, only now with the home_win variable we just created.\nwins = ( pd.melt(df.reset_index(), id_vars=['game_id', 'date', 'home_win'], value_name='team', var_name='is_home', value_vars=['home_team', 'away_team']) .assign(win=lambda x: x.home_win == (x.is_home == 'home_team')) .groupby(['team', 'is_home']) .win .agg(['sum', 'count', 'mean']) .rename(columns=dict(sum='n_wins', count='n_games', mean='win_pct')) ) wins.head() n_wins n_games win_pct team is_home Atlanta Hawks away_team 21.0 41 0.512195 home_team 27.0 41 0.658537 Boston Celtics away_team 20.0 41 0.487805 home_team 28.0 41 0.682927 Brooklyn Nets away_team 7.0 41 0.170732 Pause for visualiztion, because why not\ng = sns.FacetGrid(wins.reset_index(), hue='team', size=7, aspect=.5, palette=['k']) g.map(sns.pointplot, 'is_home', 'win_pct').set(ylim=(0, 1)); (It’d be great if there was a library built on top of matplotlib that auto-labeled each point decently well. Apparently this is a difficult problem to do in general).\ng = sns.FacetGrid(wins.reset_index(), col='team', hue='team', col_wrap=5, size=2) g.map(sns.pointplot, 'is_home', 'win_pct') Those two graphs show that most teams have a higher win-percent at home than away. So we can continue to investigate. Let’s aggregate over home / away to get an overall win percent per team.\nwin_percent = ( # Use sum(games) / sum(games) instead of mean # since I don't know if teams play the same # number of games at home as away wins.groupby(level='team', as_index=True) .apply(lambda x: x.n_wins.sum() / x.n_games.sum()) ) win_percent.head() team Atlanta Hawks 0.585366 Boston Celtics 0.585366 Brooklyn Nets 0.256098 Charlotte Hornets 0.585366 Chicago Bulls 0.512195 dtype: float64 win_percent.sort_values().plot.barh(figsize=(6, 12), width=.85, color='k') plt.tight_layout() sns.despine() plt.xlabel(\"Win Percent\") Is there a relationship between overall team strength and their home-court advantage?\nplt.figure(figsize=(8, 5)) (wins.win_pct .unstack() .assign(**{'Home Win % - Away %': lambda x: x.home_team - x.away_team, 'Overall %': lambda x: (x.home_team + x.away_team) / 2}) .pipe((sns.regplot, 'data'), x='Overall %', y='Home Win % - Away %') ) sns.despine() plt.tight_layout() Let’s get the team strength back into df. You could you pd.merge, but I prefer .map when joining a Series.\ndf = df.assign(away_strength=df['away_team'].map(win_percent), home_strength=df['home_team'].map(win_percent), point_diff=df['home_points'] - df['away_points'], rest_diff=df['home_rest'] - df['away_rest']) df.head() away_team away_points home_team home_points away_rest home_rest home_win rest_spread away_strength home_strength point_diff rest_diff game_id date 1 2015-10-27 Detroit Pistons 106.0 Atlanta Hawks 94.0 NaN NaN False NaN 0.536585 0.585366 -12.0 NaN 2 2015-10-27 Cleveland Cavaliers 95.0 Chicago Bulls 97.0 NaN NaN True NaN 0.695122 0.512195 2.0 NaN 3 2015-10-27 New Orleans Pelicans 95.0 Golden State Warriors 111.0 NaN NaN True NaN 0.365854 0.890244 16.0 NaN 4 2015-10-28 Philadelphia 76ers 95.0 Boston Celtics 112.0 NaN NaN True NaN 0.121951 0.585366 17.0 NaN 5 2015-10-28 Chicago Bulls 115.0 Brooklyn Nets 100.0 0.0 NaN False NaN 0.512195 0.256098 -15.0 NaN import statsmodels.formula.api as sm df['home_win'] = df.home_win.astype(int) # for statsmodels mod = sm.logit('home_win ~ home_strength + away_strength + home_rest + away_rest', df) res = mod.fit() res.summary() Optimization terminated successfully. Current function value: 0.552792 Iterations 6 Logit Regression Results Dep. Variable: home_win No. Observations: 1213 Model: Logit Df Residuals: 1208 Method: MLE Df Model: 4 Date: Sun, 03 Sep 2017 Pseudo R-squ.: 0.1832 Time: 07:25:41 Log-Likelihood: -670.54 converged: True LL-Null: -820.91 LLR p-value: 7.479e-64 coef std err z P\u003e|z| [0.025 0.975] Intercept 0.0707 0.314 0.225 0.822 -0.546 0.687 home_strength 5.4204 0.465 11.647 0.000 4.508 6.333 away_strength -4.7445 0.452 -10.506 0.000 -5.630 -3.859 home_rest 0.0894 0.079 1.137 0.255 -0.065 0.243 away_rest -0.0422 0.067 -0.629 0.529 -0.174 0.089 The strength variables both have large coefficeints (really we should be using some independent measure of team strength here, win_percent is showing up on the left and right side of the equation). The rest variables don’t seem to matter as much.\nWith .assign we can quickly explore variations in formula.\n(sm.Logit.from_formula('home_win ~ strength_diff + rest_spread', df.assign(strength_diff=df.home_strength - df.away_strength)) .fit().summary()) Optimization terminated successfully. Current function value: 0.553499 Iterations 6 Logit Regression Results Dep. Variable: home_win No. Observations: 1213 Model: Logit Df Residuals: 1210 Method: MLE Df Model: 2 Date: Sun, 03 Sep 2017 Pseudo R-squ.: 0.1821 Time: 07:25:41 Log-Likelihood: -671.39 converged: True LL-Null: -820.91 LLR p-value: 1.165e-65 coef std err z P\u003e|z| [0.025 0.975] Intercept 0.4610 0.068 6.756 0.000 0.327 0.595 strength_diff 5.0671 0.349 14.521 0.000 4.383 5.751 rest_spread 0.0566 0.062 0.912 0.362 -0.065 0.178 mod = sm.Logit.from_formula('home_win ~ home_rest + away_rest', df) res = mod.fit() res.summary() Optimization terminated successfully. Current function value: 0.676549 Iterations 4 Logit Regression Results Dep. Variable: home_win No. Observations: 1213 Model: Logit Df Residuals: 1210 Method: MLE Df Model: 2 Date: Sun, 03 Sep 2017 Pseudo R-squ.: 0.0003107 Time: 07:25:41 Log-Likelihood: -820.65 converged: True LL-Null: -820.91 LLR p-value: 0.7749 coef std err z P\u003e|z| [0.025 0.975] Intercept 0.3667 0.094 3.889 0.000 0.182 0.552 home_rest 0.0338 0.069 0.486 0.627 -0.102 0.170 away_rest -0.0420 0.061 -0.693 0.488 -0.161 0.077 Overall not seeing to much support for rest mattering, but we got to see some more tidy data.\nThat’s it for today. Next time we’ll look at data visualization.\n","wordCount":"2583","inLanguage":"en","datePublished":"2016-04-22T00:00:00Z","dateModified":"2016-04-22T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tomaugspurger.net/posts/modern-5-tidy/"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://tomaugspurger.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tomaugspurger.net accesskey=h title="Tom's Blog (Alt + H)">Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tomaugspurger.net/about/ title=About><span>About</span></a></li><li><a href=https://tomaugspurger.net/archives title=Archive><span>Archive</span></a></li><li><a href=https://tomaugspurger.net/index.xml title=RSS><span>RSS</span></a></li><li><a href=https://tomaugspurger.net/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Modern Pandas (Part 5): Tidy Data</h1><div class=post-meta>&lt;span title='2016-04-22 00:00:00 +0000 UTC'>April 22, 2016&lt;/span></div></header><div class=post-content><hr><p>This is part 5 in my series on writing modern idiomatic pandas.</p><ul><li><a href=/posts/modern-1-intro>Modern Pandas</a></li><li><a href=/posts/method-chaining>Method Chaining</a></li><li><a href=/posts/modern-3-indexes>Indexes</a></li><li><a href=/posts/modern-4-performance>Fast Pandas</a></li><li><a href=/posts/modern-5-tidy>Tidy Data</a></li><li><a href=/posts/modern-6-visualization>Visualization</a></li><li><a href=/posts/modern-7-timeseries>Time Series</a></li><li><a href=/posts/modern-8-scaling>Scaling</a></li></ul><hr><h1 id=reshaping--tidy-data>Reshaping & Tidy Data<a hidden class=anchor aria-hidden=true href=#reshaping--tidy-data>#</a></h1><blockquote><p>Structuring datasets to facilitate analysis <a href=http://www.jstatsoft.org/v59/i10/paper>(Wickham 2014)</a></p></blockquote><p>So, you&rsquo;ve sat down to analyze a new dataset.
What do you do first?</p><p>In episode 11 of <a href="https://www.patreon.com/NSSDeviations?ty=h">Not So Standard Deviations</a>, Hilary and Roger discussed their typical approaches.
I&rsquo;m with Hilary on this one, you should make sure your data is tidy.
Before you do any plots, filtering, transformations, summary statistics, regressions&mldr;
Without a tidy dataset, you&rsquo;ll be fighting your tools to get the result you need.
With a tidy dataset, it&rsquo;s relatively easy to do all of those.</p><p>Hadley Wickham kindly summarized tidiness as a dataset where</p><ol><li>Each variable forms a column</li><li>Each observation forms a row</li><li>Each type of observational unit forms a table</li></ol><p>And today we&rsquo;ll only concern ourselves with the first two.
As quoted at the top, this really is about facilitating analysis: going as quickly as possible from question to answer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%</span>matplotlib inline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> seaborn <span style=color:#66d9ef>as</span> sns
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#66d9ef>as</span> plt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> int(os<span style=color:#f92672>.</span>environ<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;MODERN_PANDAS_EPUB&#34;</span>, <span style=color:#ae81ff>0</span>)):
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> prep <span style=color:#75715e># noqa</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pd<span style=color:#f92672>.</span>options<span style=color:#f92672>.</span>display<span style=color:#f92672>.</span>max_rows <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>set(style<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ticks&#39;</span>, context<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;talk&#39;</span>)
</span></span></code></pre></div><h2 id=nba-data>NBA Data<a hidden class=anchor aria-hidden=true href=#nba-data>#</a></h2><p><a href=http://stackoverflow.com/questions/22695680/python-pandas-timedelta-specific-rows>This</a> StackOverflow question asked about calculating the number of days of rest NBA teams have between games.
The answer would have been difficult to compute with the raw data.
After transforming the dataset to be tidy, we&rsquo;re able to quickly get the answer.</p><p>We&rsquo;ll grab some NBA game data from basketball-reference.com using pandas&rsquo; <code>read_html</code> function, which returns a list of DataFrames.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;data/nba.csv&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(fp):
</span></span><span style=display:flex><span>    tables <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_html(<span style=color:#e6db74>&#34;http://www.basketball-reference.com/leagues/NBA_2016_games.html&#34;</span>)
</span></span><span style=display:flex><span>    games <span style=color:#f92672>=</span> tables[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    games<span style=color:#f92672>.</span>to_csv(fp)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    games <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(fp)
</span></span><span style=display:flex><span>games<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th>Date</th><th>Start (ET)</th><th>Unnamed: 2</th><th>Visitor/Neutral</th><th>PTS</th><th>Home/Neutral</th><th>PTS.1</th><th>Unnamed: 7</th><th>Notes</th></tr></thead><tbody><tr><th>0</th><td>October</td><td>NaN</td><td>NaN</td><td>NaN</td><td>NaN</td><td>NaN</td><td>NaN</td><td>NaN</td><td>NaN</td></tr><tr><th>1</th><td>Tue, Oct 27, 2015</td><td>8:00 pm</td><td>Box Score</td><td>Detroit Pistons</td><td>106.0</td><td>Atlanta Hawks</td><td>94.0</td><td>NaN</td><td>NaN</td></tr><tr><th>2</th><td>Tue, Oct 27, 2015</td><td>8:00 pm</td><td>Box Score</td><td>Cleveland Cavaliers</td><td>95.0</td><td>Chicago Bulls</td><td>97.0</td><td>NaN</td><td>NaN</td></tr><tr><th>3</th><td>Tue, Oct 27, 2015</td><td>10:30 pm</td><td>Box Score</td><td>New Orleans Pelicans</td><td>95.0</td><td>Golden State Warriors</td><td>111.0</td><td>NaN</td><td>NaN</td></tr><tr><th>4</th><td>Wed, Oct 28, 2015</td><td>7:30 pm</td><td>Box Score</td><td>Philadelphia 76ers</td><td>95.0</td><td>Boston Celtics</td><td>112.0</td><td>NaN</td><td>NaN</td></tr></tbody></table></div><p>Side note: pandas&rsquo; <code>read_html</code> is pretty good. On simple websites it almost always works.
It provides a couple parameters for controlling what gets selected from the webpage if the defaults fail.
I&rsquo;ll always use it first, before moving on to <a href=https://www.crummy.com/software/BeautifulSoup/>BeautifulSoup</a> or <a href=http://lxml.de/>lxml</a> if the page is more complicated.</p><p>As you can see, we have a bit of general munging to do before tidying.
Each month slips in an extra row of mostly NaNs, the column names aren&rsquo;t too useful, and we have some dtypes to fix up.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>column_names <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;Date&#39;</span>: <span style=color:#e6db74>&#39;date&#39;</span>, <span style=color:#e6db74>&#39;Start (ET)&#39;</span>: <span style=color:#e6db74>&#39;start&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;Unamed: 2&#39;</span>: <span style=color:#e6db74>&#39;box&#39;</span>, <span style=color:#e6db74>&#39;Visitor/Neutral&#39;</span>: <span style=color:#e6db74>&#39;away_team&#39;</span>, 
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;PTS&#39;</span>: <span style=color:#e6db74>&#39;away_points&#39;</span>, <span style=color:#e6db74>&#39;Home/Neutral&#39;</span>: <span style=color:#e6db74>&#39;home_team&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;PTS.1&#39;</span>: <span style=color:#e6db74>&#39;home_points&#39;</span>, <span style=color:#e6db74>&#39;Unamed: 7&#39;</span>: <span style=color:#e6db74>&#39;n_ot&#39;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>games <span style=color:#f92672>=</span> (games<span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>column_names)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>dropna(thresh<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    [[<span style=color:#e6db74>&#39;date&#39;</span>, <span style=color:#e6db74>&#39;away_team&#39;</span>, <span style=color:#e6db74>&#39;away_points&#39;</span>, <span style=color:#e6db74>&#39;home_team&#39;</span>, <span style=color:#e6db74>&#39;home_points&#39;</span>]]
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>assign(date<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: pd<span style=color:#f92672>.</span>to_datetime(x[<span style=color:#e6db74>&#39;date&#39;</span>], format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%a</span><span style=color:#e6db74>, %b </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>, %Y&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>set_index(<span style=color:#e6db74>&#39;date&#39;</span>, append<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>rename_axis([<span style=color:#e6db74>&#34;game_id&#34;</span>, <span style=color:#e6db74>&#34;date&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>sort_index())
</span></span><span style=display:flex><span>games<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th></th><th>away_team</th><th>away_points</th><th>home_team</th><th>home_points</th></tr><tr><th>game_id</th><th>date</th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>1</th><th>2015-10-27</th><td>Detroit Pistons</td><td>106.0</td><td>Atlanta Hawks</td><td>94.0</td></tr><tr><th>2</th><th>2015-10-27</th><td>Cleveland Cavaliers</td><td>95.0</td><td>Chicago Bulls</td><td>97.0</td></tr><tr><th>3</th><th>2015-10-27</th><td>New Orleans Pelicans</td><td>95.0</td><td>Golden State Warriors</td><td>111.0</td></tr><tr><th>4</th><th>2015-10-28</th><td>Philadelphia 76ers</td><td>95.0</td><td>Boston Celtics</td><td>112.0</td></tr><tr><th>5</th><th>2015-10-28</th><td>Chicago Bulls</td><td>115.0</td><td>Brooklyn Nets</td><td>100.0</td></tr></tbody></table></div><p>A quick aside on that last block.</p><ul><li><code>dropna</code> has a <code>thresh</code> argument. If at least <code>thresh</code> items are missing, the row is dropped. We used it to remove the &ldquo;Month headers&rdquo; that slipped into the table.</li><li><code>assign</code> can take a callable. This lets us refer to the DataFrame in the previous step of the chain. Otherwise we would have to assign <code>temp_df = games.dropna()...</code> And then do the <code>pd.to_datetime</code> on that.</li><li><code>set_index</code> has an <code>append</code> keyword. We keep the original index around since it will be our unique identifier per game.</li><li>We use <code>.rename_axis</code> to set the index names (this behavior is new in pandas 0.18; before <code>.rename_axis</code> only took a mapping for changing labels).</li></ul><p>The Question:</p><blockquote><p><strong>How many days of rest did each team get between each game?</strong></p></blockquote><p>Whether or not your dataset is tidy depends on your question. Given our question, what is an observation?</p><p>In this case, an observation is a <code>(team, game)</code> pair, which we don&rsquo;t have yet. Rather, we have two observations per row, one for home and one for away. We&rsquo;ll fix that with <code>pd.melt</code>.</p><p><code>pd.melt</code> works by taking observations that are spread across columns (<code>away_team</code>, <code>home_team</code>), and melting them down into one column with multiple rows. However, we don&rsquo;t want to lose the metadata (like <code>game_id</code> and <code>date</code>) that is shared between the observations. By including those columns as <code>id_vars</code>, the values will be repeated as many times as needed to stay with their observations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tidy <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>melt(games<span style=color:#f92672>.</span>reset_index(),
</span></span><span style=display:flex><span>               id_vars<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;game_id&#39;</span>, <span style=color:#e6db74>&#39;date&#39;</span>], value_vars<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;away_team&#39;</span>, <span style=color:#e6db74>&#39;home_team&#39;</span>],
</span></span><span style=display:flex><span>               value_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>)
</span></span><span style=display:flex><span>tidy<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th>game_id</th><th>date</th><th>variable</th><th>team</th></tr></thead><tbody><tr><th>0</th><td>1</td><td>2015-10-27</td><td>away_team</td><td>Detroit Pistons</td></tr><tr><th>1</th><td>2</td><td>2015-10-27</td><td>away_team</td><td>Cleveland Cavaliers</td></tr><tr><th>2</th><td>3</td><td>2015-10-27</td><td>away_team</td><td>New Orleans Pelicans</td></tr><tr><th>3</th><td>4</td><td>2015-10-28</td><td>away_team</td><td>Philadelphia 76ers</td></tr><tr><th>4</th><td>5</td><td>2015-10-28</td><td>away_team</td><td>Chicago Bulls</td></tr></tbody></table></div><p>The DataFrame <code>tidy</code> meets our rules for tidiness: each variable is in a column, and each observation (<code>team</code>, <code>date</code> pair) is on its own row.
Now the translation from question (&ldquo;How many days of rest between games&rdquo;) to operation (&ldquo;date of today&rsquo;s game - date of previous game - 1&rdquo;) is direct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># For each team... get number of days between games</span>
</span></span><span style=display:flex><span>tidy<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#39;team&#39;</span>)[<span style=color:#e6db74>&#39;date&#39;</span>]<span style=color:#f92672>.</span>diff()<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>days <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><pre><code>0       NaN
1       NaN
2       NaN
3       NaN
4       NaN
       ... 
2455    7.0
2456    1.0
2457    1.0
2458    3.0
2459    2.0
Name: date, Length: 2460, dtype: float64
</code></pre><p>That&rsquo;s the essence of tidy data, the reason why it&rsquo;s worth considering what shape your data should be in.
It&rsquo;s about setting yourself up for success so that the answers naturally flow from the data (just kidding, it&rsquo;s usually still difficult. But hopefully less so).</p><p>Let&rsquo;s assign that back into our DataFrame</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tidy[<span style=color:#e6db74>&#39;rest&#39;</span>] <span style=color:#f92672>=</span> tidy<span style=color:#f92672>.</span>sort_values(<span style=color:#e6db74>&#39;date&#39;</span>)<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#39;team&#39;</span>)<span style=color:#f92672>.</span>date<span style=color:#f92672>.</span>diff()<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>days <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>tidy<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th>game_id</th><th>date</th><th>variable</th><th>team</th><th>rest</th></tr></thead><tbody><tr><th>4</th><td>5</td><td>2015-10-28</td><td>away_team</td><td>Chicago Bulls</td><td>0.0</td></tr><tr><th>8</th><td>9</td><td>2015-10-28</td><td>away_team</td><td>Cleveland Cavaliers</td><td>0.0</td></tr><tr><th>14</th><td>15</td><td>2015-10-28</td><td>away_team</td><td>New Orleans Pelicans</td><td>0.0</td></tr><tr><th>17</th><td>18</td><td>2015-10-29</td><td>away_team</td><td>Memphis Grizzlies</td><td>0.0</td></tr><tr><th>18</th><td>19</td><td>2015-10-29</td><td>away_team</td><td>Dallas Mavericks</td><td>0.0</td></tr></tbody></table></div><p>To show the inverse of <code>melt</code>, let&rsquo;s take <code>rest</code> values we just calculated and place them back in the original DataFrame with a <code>pivot_table</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>by_game <span style=color:#f92672>=</span> (pd<span style=color:#f92672>.</span>pivot_table(tidy, values<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rest&#39;</span>,
</span></span><span style=display:flex><span>                          index<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;game_id&#39;</span>, <span style=color:#e6db74>&#39;date&#39;</span>],
</span></span><span style=display:flex><span>                          columns<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;variable&#39;</span>)
</span></span><span style=display:flex><span>             <span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;away_team&#39;</span>: <span style=color:#e6db74>&#39;away_rest&#39;</span>,
</span></span><span style=display:flex><span>                              <span style=color:#e6db74>&#39;home_team&#39;</span>: <span style=color:#e6db74>&#39;home_rest&#39;</span>}))
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>concat([games, by_game], axis<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th></th><th>away_team</th><th>away_points</th><th>home_team</th><th>home_points</th><th>away_rest</th><th>home_rest</th></tr><tr><th>game_id</th><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>18</th><th>2015-10-29</th><td>Memphis Grizzlies</td><td>112.0</td><td>Indiana Pacers</td><td>103.0</td><td>0.0</td><td>0.0</td></tr><tr><th>19</th><th>2015-10-29</th><td>Dallas Mavericks</td><td>88.0</td><td>Los Angeles Clippers</td><td>104.0</td><td>0.0</td><td>0.0</td></tr><tr><th>20</th><th>2015-10-29</th><td>Atlanta Hawks</td><td>112.0</td><td>New York Knicks</td><td>101.0</td><td>1.0</td><td>0.0</td></tr><tr><th>21</th><th>2015-10-30</th><td>Charlotte Hornets</td><td>94.0</td><td>Atlanta Hawks</td><td>97.0</td><td>1.0</td><td>0.0</td></tr><tr><th>22</th><th>2015-10-30</th><td>Toronto Raptors</td><td>113.0</td><td>Boston Celtics</td><td>103.0</td><td>1.0</td><td>1.0</td></tr></tbody></table></div><p>One somewhat subtle point: an &ldquo;observation&rdquo; depends on the question being asked.
So really, we have two tidy datasets, <code>tidy</code> for answering team-level questions, and <code>df</code> for answering game-level questions.</p><p>One potentially interesting question is &ldquo;what was each team&rsquo;s average days of rest, at home and on the road?&rdquo; With a tidy dataset (the DataFrame <code>tidy</code>, since it&rsquo;s team-level), <code>seaborn</code> makes this easy (more on seaborn in a future post):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>sns<span style=color:#f92672>.</span>set(style<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ticks&#39;</span>, context<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;paper&#39;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>g <span style=color:#f92672>=</span> sns<span style=color:#f92672>.</span>FacetGrid(tidy, col<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, col_wrap<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, hue<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, size<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>g<span style=color:#f92672>.</span>map(sns<span style=color:#f92672>.</span>barplot, <span style=color:#e6db74>&#39;variable&#39;</span>, <span style=color:#e6db74>&#39;rest&#39;</span>);
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_17_0.png alt=png></p><p>An example of a game-level statistic is the distribution of rest differences in games:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df[<span style=color:#e6db74>&#39;home_win&#39;</span>] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;home_points&#39;</span>] <span style=color:#f92672>&gt;</span> df[<span style=color:#e6db74>&#39;away_points&#39;</span>]
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;rest_spread&#39;</span>] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;home_rest&#39;</span>] <span style=color:#f92672>-</span> df[<span style=color:#e6db74>&#39;away_rest&#39;</span>]
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th></th><th>away_team</th><th>away_points</th><th>home_team</th><th>home_points</th><th>away_rest</th><th>home_rest</th><th>home_win</th><th>rest_spread</th></tr><tr><th>game_id</th><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>18</th><th>2015-10-29</th><td>Memphis Grizzlies</td><td>112.0</td><td>Indiana Pacers</td><td>103.0</td><td>0.0</td><td>0.0</td><td>False</td><td>0.0</td></tr><tr><th>19</th><th>2015-10-29</th><td>Dallas Mavericks</td><td>88.0</td><td>Los Angeles Clippers</td><td>104.0</td><td>0.0</td><td>0.0</td><td>True</td><td>0.0</td></tr><tr><th>20</th><th>2015-10-29</th><td>Atlanta Hawks</td><td>112.0</td><td>New York Knicks</td><td>101.0</td><td>1.0</td><td>0.0</td><td>False</td><td>-1.0</td></tr><tr><th>21</th><th>2015-10-30</th><td>Charlotte Hornets</td><td>94.0</td><td>Atlanta Hawks</td><td>97.0</td><td>1.0</td><td>0.0</td><td>True</td><td>-1.0</td></tr><tr><th>22</th><th>2015-10-30</th><td>Toronto Raptors</td><td>113.0</td><td>Boston Celtics</td><td>103.0</td><td>1.0</td><td>1.0</td><td>False</td><td>0.0</td></tr></tbody></table></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>delta <span style=color:#f92672>=</span> (by_game<span style=color:#f92672>.</span>home_rest <span style=color:#f92672>-</span> by_game<span style=color:#f92672>.</span>away_rest)<span style=color:#f92672>.</span>dropna()<span style=color:#f92672>.</span>astype(int)
</span></span><span style=display:flex><span>ax <span style=color:#f92672>=</span> (delta<span style=color:#f92672>.</span>value_counts()
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>reindex(np<span style=color:#f92672>.</span>arange(delta<span style=color:#f92672>.</span>min(), delta<span style=color:#f92672>.</span>max() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>), fill_value<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>sort_index()
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>plot(kind<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;bar&#39;</span>, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;k&#39;</span>, width<span style=color:#f92672>=</span><span style=color:#ae81ff>.9</span>, rot<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>despine()
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>set(xlabel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Difference in Rest (Home - Away)&#39;</span>, ylabel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Games&#39;</span>);
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_20_0.png alt=png></p><p>Or the win percent by rest difference</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fig, ax <span style=color:#f92672>=</span> plt<span style=color:#f92672>.</span>subplots(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>6</span>))
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>barplot(x<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rest_spread&#39;</span>, y<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;home_win&#39;</span>, data<span style=color:#f92672>=</span>df<span style=color:#f92672>.</span>query(<span style=color:#e6db74>&#39;-3 &lt;= rest_spread &lt;= 3&#39;</span>),
</span></span><span style=display:flex><span>            color<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;#4c72b0&#39;</span>, ax<span style=color:#f92672>=</span>ax)
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>despine()
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_22_0.png alt=png></p><h2 id=stack--unstack>Stack / Unstack<a hidden class=anchor aria-hidden=true href=#stack--unstack>#</a></h2><p>Pandas has two useful methods for quickly converting from wide to long format (<code>stack</code>) and long to wide (<code>unstack</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>rest <span style=color:#f92672>=</span> (tidy<span style=color:#f92672>.</span>groupby([<span style=color:#e6db74>&#39;date&#39;</span>, <span style=color:#e6db74>&#39;variable&#39;</span>])
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span>rest<span style=color:#f92672>.</span>mean()
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span>dropna())
</span></span><span style=display:flex><span>rest<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><pre><code>date        variable 
2015-10-28  away_team    0.000000
            home_team    0.000000
2015-10-29  away_team    0.333333
            home_team    0.000000
2015-10-30  away_team    1.083333
Name: rest, dtype: float64
</code></pre><p><code>rest</code> is in a &ldquo;long&rdquo; form since we have a single column of data, with multiple &ldquo;columns&rdquo; of metadata (in the MultiIndex). We use <code>.unstack</code> to move from long to wide.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>rest<span style=color:#f92672>.</span>unstack()<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th>variable</th><th>away_team</th><th>home_team</th></tr><tr><th>date</th><th></th><th></th></tr></thead><tbody><tr><th>2015-10-28</th><td>0.000000</td><td>0.000000</td></tr><tr><th>2015-10-29</th><td>0.333333</td><td>0.000000</td></tr><tr><th>2015-10-30</th><td>1.083333</td><td>0.916667</td></tr><tr><th>2015-10-31</th><td>0.166667</td><td>0.833333</td></tr><tr><th>2015-11-01</th><td>1.142857</td><td>1.000000</td></tr></tbody></table></div><p><code>unstack</code> moves a level of a MultiIndex (innermost by default) up to the columns.
<code>stack</code> is the inverse.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>rest<span style=color:#f92672>.</span>unstack()<span style=color:#f92672>.</span>stack()
</span></span></code></pre></div><pre><code>date        variable 
2015-10-28  away_team    0.000000
            home_team    0.000000
2015-10-29  away_team    0.333333
            home_team    0.000000
2015-10-30  away_team    1.083333
                           ...   
2016-04-11  home_team    0.666667
2016-04-12  away_team    1.000000
            home_team    1.400000
2016-04-13  away_team    0.500000
            home_team    1.214286
Length: 320, dtype: float64
</code></pre><p>With <code>.unstack</code> you can move between those APIs that expect there data in long-format and those APIs that work with wide-format data. For example, <code>DataFrame.plot()</code>, works with wide-form data, one line per column.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>with</span> sns<span style=color:#f92672>.</span>color_palette() <span style=color:#66d9ef>as</span> pal:
</span></span><span style=display:flex><span>    b, g <span style=color:#f92672>=</span> pal<span style=color:#f92672>.</span>as_hex()[:<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ax<span style=color:#f92672>=</span>(rest<span style=color:#f92672>.</span>unstack()
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>query(<span style=color:#e6db74>&#39;away_team &lt; 7&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>rolling(<span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>mean()
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>plot(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>6</span>), linewidth<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, legend<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>))
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>set(ylabel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Rest (7 day MA)&#39;</span>)
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>annotate(<span style=color:#e6db74>&#34;Home&#34;</span>, (rest<span style=color:#f92672>.</span>index[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#ae81ff>0</span>], <span style=color:#ae81ff>1.02</span>), color<span style=color:#f92672>=</span>g, size<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>)
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>annotate(<span style=color:#e6db74>&#34;Away&#34;</span>, (rest<span style=color:#f92672>.</span>index[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#ae81ff>0</span>], <span style=color:#ae81ff>0.82</span>), color<span style=color:#f92672>=</span>b, size<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>)
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>despine()
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_30_0.png alt=png></p><p>The most conenient form will depend on exactly what you&rsquo;re doing.
When interacting with databases you&rsquo;ll often deal with long form data.
Pandas&rsquo; <code>DataFrame.plot</code> often expects wide-form data, while <code>seaborn</code> often expect long-form data. Regressions will expect wide-form data. Either way, it&rsquo;s good to be comfortable with <code>stack</code> and <code>unstack</code> (and MultiIndexes) to quickly move between the two.</p><h2 id=mini-project-home-court-advantage>Mini Project: Home Court Advantage?<a hidden class=anchor aria-hidden=true href=#mini-project-home-court-advantage>#</a></h2><p>We&rsquo;ve gone to all that work tidying our dataset, let&rsquo;s put it to use.
What&rsquo;s the effect (in terms of probability to win) of being
the home team?</p><h3 id=step-1-create-an-outcome-variable>Step 1: Create an outcome variable<a hidden class=anchor aria-hidden=true href=#step-1-create-an-outcome-variable>#</a></h3><p>We need to create an indicator for whether the home team won.
Add it as a column called <code>home_win</code> in <code>games</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df[<span style=color:#e6db74>&#39;home_win&#39;</span>] <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>home_points <span style=color:#f92672>&gt;</span> df<span style=color:#f92672>.</span>away_points
</span></span></code></pre></div><h3 id=step-2-find-the-win-percent-for-each-team>Step 2: Find the win percent for each team<a hidden class=anchor aria-hidden=true href=#step-2-find-the-win-percent-for-each-team>#</a></h3><p>In the 10-minute literature review I did on the topic, it seems like people include a team-strength variable in their regressions.
I suppose that makes sense; if stronger teams happened to play against weaker teams at home more often than away, it&rsquo;d look like the home-effect is stronger than it actually is.
We&rsquo;ll do a terrible job of controlling for team strength by calculating each team&rsquo;s win percent and using that as a predictor.
It&rsquo;d be better to use some kind of independent measure of team strength, but this will do for now.</p><p>We&rsquo;ll use a similar <code>melt</code> operation as earlier, only now with the <code>home_win</code> variable we just created.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>wins <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    pd<span style=color:#f92672>.</span>melt(df<span style=color:#f92672>.</span>reset_index(),
</span></span><span style=display:flex><span>            id_vars<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;game_id&#39;</span>, <span style=color:#e6db74>&#39;date&#39;</span>, <span style=color:#e6db74>&#39;home_win&#39;</span>],
</span></span><span style=display:flex><span>            value_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, var_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;is_home&#39;</span>,
</span></span><span style=display:flex><span>            value_vars<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;home_team&#39;</span>, <span style=color:#e6db74>&#39;away_team&#39;</span>])
</span></span><span style=display:flex><span>   <span style=color:#f92672>.</span>assign(win<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x<span style=color:#f92672>.</span>home_win <span style=color:#f92672>==</span> (x<span style=color:#f92672>.</span>is_home <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;home_team&#39;</span>))
</span></span><span style=display:flex><span>   <span style=color:#f92672>.</span>groupby([<span style=color:#e6db74>&#39;team&#39;</span>, <span style=color:#e6db74>&#39;is_home&#39;</span>])
</span></span><span style=display:flex><span>   <span style=color:#f92672>.</span>win
</span></span><span style=display:flex><span>   <span style=color:#f92672>.</span>agg([<span style=color:#e6db74>&#39;sum&#39;</span>, <span style=color:#e6db74>&#39;count&#39;</span>, <span style=color:#e6db74>&#39;mean&#39;</span>])
</span></span><span style=display:flex><span>   <span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>dict(sum<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;n_wins&#39;</span>,
</span></span><span style=display:flex><span>                        count<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;n_games&#39;</span>,
</span></span><span style=display:flex><span>                        mean<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;win_pct&#39;</span>))
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>wins<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th></th><th>n_wins</th><th>n_games</th><th>win_pct</th></tr><tr><th>team</th><th>is_home</th><th></th><th></th><th></th></tr></thead><tbody><tr><th rowspan=2 valign=top>Atlanta Hawks</th><th>away_team</th><td>21.0</td><td>41</td><td>0.512195</td></tr><tr><th>home_team</th><td>27.0</td><td>41</td><td>0.658537</td></tr><tr><th rowspan=2 valign=top>Boston Celtics</th><th>away_team</th><td>20.0</td><td>41</td><td>0.487805</td></tr><tr><th>home_team</th><td>28.0</td><td>41</td><td>0.682927</td></tr><tr><th>Brooklyn Nets</th><th>away_team</th><td>7.0</td><td>41</td><td>0.170732</td></tr></tbody></table></div><p>Pause for visualiztion, because why not</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>g <span style=color:#f92672>=</span> sns<span style=color:#f92672>.</span>FacetGrid(wins<span style=color:#f92672>.</span>reset_index(), hue<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, size<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>, aspect<span style=color:#f92672>=</span><span style=color:#ae81ff>.5</span>, palette<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;k&#39;</span>])
</span></span><span style=display:flex><span>g<span style=color:#f92672>.</span>map(sns<span style=color:#f92672>.</span>pointplot, <span style=color:#e6db74>&#39;is_home&#39;</span>, <span style=color:#e6db74>&#39;win_pct&#39;</span>)<span style=color:#f92672>.</span>set(ylim<span style=color:#f92672>=</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>));
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_38_0.png alt=png></p><p>(It&rsquo;d be great if there was a library built on top of matplotlib that auto-labeled each point decently well. Apparently this is a difficult problem to do in general).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>g <span style=color:#f92672>=</span> sns<span style=color:#f92672>.</span>FacetGrid(wins<span style=color:#f92672>.</span>reset_index(), col<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, hue<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, col_wrap<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>, size<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>g<span style=color:#f92672>.</span>map(sns<span style=color:#f92672>.</span>pointplot, <span style=color:#e6db74>&#39;is_home&#39;</span>, <span style=color:#e6db74>&#39;win_pct&#39;</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.FacetGrid at 0x11a0fe588&gt;
</code></pre><p><img loading=lazy src=/images/modern_5_tidy_40_1.png alt=png></p><p>Those two graphs show that most teams have a higher win-percent at home than away. So we can continue to investigate.
Let&rsquo;s aggregate over home / away to get an overall win percent per team.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>win_percent <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use sum(games) / sum(games) instead of mean</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># since I don&#39;t know if teams play the same</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># number of games at home as away</span>
</span></span><span style=display:flex><span>    wins<span style=color:#f92672>.</span>groupby(level<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;team&#39;</span>, as_index<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>apply(<span style=color:#66d9ef>lambda</span> x: x<span style=color:#f92672>.</span>n_wins<span style=color:#f92672>.</span>sum() <span style=color:#f92672>/</span> x<span style=color:#f92672>.</span>n_games<span style=color:#f92672>.</span>sum())
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>win_percent<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><pre><code>team
Atlanta Hawks        0.585366
Boston Celtics       0.585366
Brooklyn Nets        0.256098
Charlotte Hornets    0.585366
Chicago Bulls        0.512195
dtype: float64
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>win_percent<span style=color:#f92672>.</span>sort_values()<span style=color:#f92672>.</span>plot<span style=color:#f92672>.</span>barh(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>12</span>), width<span style=color:#f92672>=</span><span style=color:#ae81ff>.85</span>, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;k&#39;</span>)
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>tight_layout()
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>despine()
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>xlabel(<span style=color:#e6db74>&#34;Win Percent&#34;</span>)
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_43_1.png alt=png></p><p>Is there a relationship between overall team strength and their home-court advantage?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>plt<span style=color:#f92672>.</span>figure(figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>(wins<span style=color:#f92672>.</span>win_pct
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>unstack()
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>assign(<span style=color:#f92672>**</span>{<span style=color:#e6db74>&#39;Home Win % - Away %&#39;</span>: <span style=color:#66d9ef>lambda</span> x: x<span style=color:#f92672>.</span>home_team <span style=color:#f92672>-</span> x<span style=color:#f92672>.</span>away_team,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#39;Overall %&#39;</span>: <span style=color:#66d9ef>lambda</span> x: (x<span style=color:#f92672>.</span>home_team <span style=color:#f92672>+</span> x<span style=color:#f92672>.</span>away_team) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>})
</span></span><span style=display:flex><span>     <span style=color:#f92672>.</span>pipe((sns<span style=color:#f92672>.</span>regplot, <span style=color:#e6db74>&#39;data&#39;</span>), x<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Overall %&#39;</span>, y<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Home Win % - Away %&#39;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>sns<span style=color:#f92672>.</span>despine()
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>tight_layout()
</span></span></code></pre></div><p><img loading=lazy src=/images/modern_5_tidy_45_0.png alt=png></p><p>Let&rsquo;s get the team strength back into <code>df</code>.
You could you <code>pd.merge</code>, but I prefer <code>.map</code> when joining a <code>Series</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>assign(away_strength<span style=color:#f92672>=</span>df[<span style=color:#e6db74>&#39;away_team&#39;</span>]<span style=color:#f92672>.</span>map(win_percent),
</span></span><span style=display:flex><span>               home_strength<span style=color:#f92672>=</span>df[<span style=color:#e6db74>&#39;home_team&#39;</span>]<span style=color:#f92672>.</span>map(win_percent),
</span></span><span style=display:flex><span>               point_diff<span style=color:#f92672>=</span>df[<span style=color:#e6db74>&#39;home_points&#39;</span>] <span style=color:#f92672>-</span> df[<span style=color:#e6db74>&#39;away_points&#39;</span>],
</span></span><span style=display:flex><span>               rest_diff<span style=color:#f92672>=</span>df[<span style=color:#e6db74>&#39;home_rest&#39;</span>] <span style=color:#f92672>-</span> df[<span style=color:#e6db74>&#39;away_rest&#39;</span>])
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><div><style>.dataframe thead tr:only-child th{text-align:right}<pre><code>.dataframe thead th{text-align:left}.dataframe tbody tr th{vertical-align:top}</code></pre><p></style></p><table border=1 class=dataframe><thead><tr style=text-align:right><th></th><th></th><th>away_team</th><th>away_points</th><th>home_team</th><th>home_points</th><th>away_rest</th><th>home_rest</th><th>home_win</th><th>rest_spread</th><th>away_strength</th><th>home_strength</th><th>point_diff</th><th>rest_diff</th></tr><tr><th>game_id</th><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>1</th><th>2015-10-27</th><td>Detroit Pistons</td><td>106.0</td><td>Atlanta Hawks</td><td>94.0</td><td>NaN</td><td>NaN</td><td>False</td><td>NaN</td><td>0.536585</td><td>0.585366</td><td>-12.0</td><td>NaN</td></tr><tr><th>2</th><th>2015-10-27</th><td>Cleveland Cavaliers</td><td>95.0</td><td>Chicago Bulls</td><td>97.0</td><td>NaN</td><td>NaN</td><td>True</td><td>NaN</td><td>0.695122</td><td>0.512195</td><td>2.0</td><td>NaN</td></tr><tr><th>3</th><th>2015-10-27</th><td>New Orleans Pelicans</td><td>95.0</td><td>Golden State Warriors</td><td>111.0</td><td>NaN</td><td>NaN</td><td>True</td><td>NaN</td><td>0.365854</td><td>0.890244</td><td>16.0</td><td>NaN</td></tr><tr><th>4</th><th>2015-10-28</th><td>Philadelphia 76ers</td><td>95.0</td><td>Boston Celtics</td><td>112.0</td><td>NaN</td><td>NaN</td><td>True</td><td>NaN</td><td>0.121951</td><td>0.585366</td><td>17.0</td><td>NaN</td></tr><tr><th>5</th><th>2015-10-28</th><td>Chicago Bulls</td><td>115.0</td><td>Brooklyn Nets</td><td>100.0</td><td>0.0</td><td>NaN</td><td>False</td><td>NaN</td><td>0.512195</td><td>0.256098</td><td>-15.0</td><td>NaN</td></tr></tbody></table></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> statsmodels.formula.api <span style=color:#66d9ef>as</span> sm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;home_win&#39;</span>] <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>home_win<span style=color:#f92672>.</span>astype(int)  <span style=color:#75715e># for statsmodels</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mod <span style=color:#f92672>=</span> sm<span style=color:#f92672>.</span>logit(<span style=color:#e6db74>&#39;home_win ~ home_strength + away_strength + home_rest + away_rest&#39;</span>, df)
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> mod<span style=color:#f92672>.</span>fit()
</span></span><span style=display:flex><span>res<span style=color:#f92672>.</span>summary()
</span></span></code></pre></div><pre><code>Optimization terminated successfully.
         Current function value: 0.552792
         Iterations 6
</code></pre><table class=simpletable><caption>Logit Regression Results</caption><tr><th>Dep. Variable:</th><td>home_win</td><th>No. Observations:</th><td>1213</td></tr><tr><th>Model:</th><td>Logit</td><th>Df Residuals:</th><td>1208</td></tr><tr><th>Method:</th><td>MLE</td><th>Df Model:</th><td>4</td></tr><tr><th>Date:</th><td>Sun, 03 Sep 2017</td><th>Pseudo R-squ.:</th><td>0.1832</td></tr><tr><th>Time:</th><td>07:25:41</td><th>Log-Likelihood:</th><td>-670.54</td></tr><tr><th>converged:</th><td>True</td><th>LL-Null:</th><td>-820.91</td></tr><tr><th></th><td></td><th>LLR p-value:</th><td>7.479e-64</td></tr></table><table class=simpletable><tr><td></td><th>coef</th><th>std err</th><th>z</th><th>P>|z|</th><th>[0.025</th><th>0.975]</th></tr><tr><th>Intercept</th><td>0.0707</td><td>0.314</td><td>0.225</td><td>0.822</td><td>-0.546</td><td>0.687</td></tr><tr><th>home_strength</th><td>5.4204</td><td>0.465</td><td>11.647</td><td>0.000</td><td>4.508</td><td>6.333</td></tr><tr><th>away_strength</th><td>-4.7445</td><td>0.452</td><td>-10.506</td><td>0.000</td><td>-5.630</td><td>-3.859</td></tr><tr><th>home_rest</th><td>0.0894</td><td>0.079</td><td>1.137</td><td>0.255</td><td>-0.065</td><td>0.243</td></tr><tr><th>away_rest</th><td>-0.0422</td><td>0.067</td><td>-0.629</td><td>0.529</td><td>-0.174</td><td>0.089</td></tr></table><p>The strength variables both have large coefficeints (really we should be using some independent measure of team strength here, <code>win_percent</code> is showing up on the left and right side of the equation). The rest variables don&rsquo;t seem to matter as much.</p><p>With <code>.assign</code> we can quickly explore variations in formula.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>(sm<span style=color:#f92672>.</span>Logit<span style=color:#f92672>.</span>from_formula(<span style=color:#e6db74>&#39;home_win ~ strength_diff + rest_spread&#39;</span>,
</span></span><span style=display:flex><span>                       df<span style=color:#f92672>.</span>assign(strength_diff<span style=color:#f92672>=</span>df<span style=color:#f92672>.</span>home_strength <span style=color:#f92672>-</span> df<span style=color:#f92672>.</span>away_strength))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>fit()<span style=color:#f92672>.</span>summary())
</span></span></code></pre></div><pre><code>Optimization terminated successfully.
         Current function value: 0.553499
         Iterations 6
</code></pre><table class=simpletable><caption>Logit Regression Results</caption><tr><th>Dep. Variable:</th><td>home_win</td><th>No. Observations:</th><td>1213</td></tr><tr><th>Model:</th><td>Logit</td><th>Df Residuals:</th><td>1210</td></tr><tr><th>Method:</th><td>MLE</td><th>Df Model:</th><td>2</td></tr><tr><th>Date:</th><td>Sun, 03 Sep 2017</td><th>Pseudo R-squ.:</th><td>0.1821</td></tr><tr><th>Time:</th><td>07:25:41</td><th>Log-Likelihood:</th><td>-671.39</td></tr><tr><th>converged:</th><td>True</td><th>LL-Null:</th><td>-820.91</td></tr><tr><th></th><td></td><th>LLR p-value:</th><td>1.165e-65</td></tr></table><table class=simpletable><tr><td></td><th>coef</th><th>std err</th><th>z</th><th>P>|z|</th><th>[0.025</th><th>0.975]</th></tr><tr><th>Intercept</th><td>0.4610</td><td>0.068</td><td>6.756</td><td>0.000</td><td>0.327</td><td>0.595</td></tr><tr><th>strength_diff</th><td>5.0671</td><td>0.349</td><td>14.521</td><td>0.000</td><td>4.383</td><td>5.751</td></tr><tr><th>rest_spread</th><td>0.0566</td><td>0.062</td><td>0.912</td><td>0.362</td><td>-0.065</td><td>0.178</td></tr></table><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mod <span style=color:#f92672>=</span> sm<span style=color:#f92672>.</span>Logit<span style=color:#f92672>.</span>from_formula(<span style=color:#e6db74>&#39;home_win ~ home_rest + away_rest&#39;</span>, df)
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> mod<span style=color:#f92672>.</span>fit()
</span></span><span style=display:flex><span>res<span style=color:#f92672>.</span>summary()
</span></span></code></pre></div><pre><code>Optimization terminated successfully.
         Current function value: 0.676549
         Iterations 4
</code></pre><table class=simpletable><caption>Logit Regression Results</caption><tr><th>Dep. Variable:</th><td>home_win</td><th>No. Observations:</th><td>1213</td></tr><tr><th>Model:</th><td>Logit</td><th>Df Residuals:</th><td>1210</td></tr><tr><th>Method:</th><td>MLE</td><th>Df Model:</th><td>2</td></tr><tr><th>Date:</th><td>Sun, 03 Sep 2017</td><th>Pseudo R-squ.:</th><td>0.0003107</td></tr><tr><th>Time:</th><td>07:25:41</td><th>Log-Likelihood:</th><td>-820.65</td></tr><tr><th>converged:</th><td>True</td><th>LL-Null:</th><td>-820.91</td></tr><tr><th></th><td></td><th>LLR p-value:</th><td>0.7749</td></tr></table><table class=simpletable><tr><td></td><th>coef</th><th>std err</th><th>z</th><th>P>|z|</th><th>[0.025</th><th>0.975]</th></tr><tr><th>Intercept</th><td>0.3667</td><td>0.094</td><td>3.889</td><td>0.000</td><td>0.182</td><td>0.552</td></tr><tr><th>home_rest</th><td>0.0338</td><td>0.069</td><td>0.486</td><td>0.627</td><td>-0.102</td><td>0.170</td></tr><tr><th>away_rest</th><td>-0.0420</td><td>0.061</td><td>-0.693</td><td>0.488</td><td>-0.161</td><td>0.077</td></tr></table><p>Overall not seeing to much support for rest mattering, but we got to see some more tidy data.</p><p>That&rsquo;s it for today.
Next time we&rsquo;ll look at data visualization.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tomaugspurger.net/tags/pandas/>pandas</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://tomaugspurger.net>Tom's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><a rel=me href=https://mastodon.social/@TomAugspurger></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>