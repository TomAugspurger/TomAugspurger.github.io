<!DOCTYPE html>
<html lang="en">
<head>
          <title>DatasFrame</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link rel="stylesheet" href="./theme/css/main.css" />
        <script src="//code.jquery.com/jquery-2.2.2.min.js"></script>



    <meta name="tags" content="python" />
    <meta name="tags" content="data science" />
    <meta name="tags" content="pandas" />
    <meta name="tags" content="modern" />

</head>

<body id="index" class="home">
    <nav>
      <a href=".">Home | </a>
      <a href="/archives.html">Archive | </a>
      <a href="/categories.html">Categories | </a>
      <a href="/pages/about.html">About | </a>
      <a href="https://tomaugspurger.github.io/feeds/all.rss.xml">RSS</a>
    </nav>

<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="./modern-7-timeseries.html" rel="bookmark"
         title="Permalink to Modern Pandas (Part 7): Time Series">Modern Pandas (Part 7): Time Series</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2016-05-13T09:00:00-05:00">
      Fri 13 May 2016
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="./author/tom-augspurger.html">Tom Augspurger</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <hr />
<p>This is part 7 in my series on writing modern idiomatic pandas.</p>
<ul>
<li><a href="modern-1.html">Modern Pandas</a></li>
<li><a href="method-chaining.html">Method Chaining</a></li>
<li><a href="modern-3-indexes.html">Indexes</a></li>
<li><a href="modern-4-performance.html">Fast Pandas</a></li>
<li><a href="modern-5-tidy.html">Tidy Data</a></li>
<li><a href="modern-6-visualization.html">Visualization</a></li>
<li><a href="modern-7-timeseries.html">Time Series</a></li>
</ul>
<p><a href="https://gist.github.com/4b42cdae8e145523aab75baedd0ddfe7">This post is available as a Jupyter notebook</a></p>
<hr />
<p>Pandas started out in the financial world, so naturally it has strong time series support.
The first half of this post will look at pandas' capabilities for manipulating time series data.
The second half will discuss modeling time series data with <a href="http://www.statsmodels.org/dev/">statsmodels</a>.</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="kn">as</span> <span class="nn">web</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;talk&#39;</span><span class="p">)</span>
</pre></div>


<p>Let's grab some stock data for Goldman Sachs using the <a href="http://pandas-datareader.readthedocs.io/en/latest/"><code>pandas-datareader</code></a> package, which spun off of pandas:</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;yahoo&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2006-01-01&#39;</span><span class="p">,</span>
                    <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span>
<span class="n">gs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Adj Close</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-03</th>
      <td>126.699997</td>
      <td>129.440002</td>
      <td>124.230003</td>
      <td>128.869995</td>
      <td>6188700</td>
      <td>114.660688</td>
    </tr>
    <tr>
      <th>2006-01-04</th>
      <td>127.349998</td>
      <td>128.910004</td>
      <td>126.379997</td>
      <td>127.089996</td>
      <td>4861600</td>
      <td>113.076954</td>
    </tr>
    <tr>
      <th>2006-01-05</th>
      <td>126.000000</td>
      <td>127.320000</td>
      <td>125.610001</td>
      <td>127.040001</td>
      <td>3717400</td>
      <td>113.032471</td>
    </tr>
    <tr>
      <th>2006-01-06</th>
      <td>127.290001</td>
      <td>129.250000</td>
      <td>127.290001</td>
      <td>128.839996</td>
      <td>4319600</td>
      <td>114.633997</td>
    </tr>
    <tr>
      <th>2006-01-09</th>
      <td>128.500000</td>
      <td>130.619995</td>
      <td>128.000000</td>
      <td>130.389999</td>
      <td>4723500</td>
      <td>116.013096</td>
    </tr>
  </tbody>
</table>
</div>

<p>There isn't a special data-container just for time series in pandas, they're just <code>Series</code> or <code>DataFrame</code>s with a <code>DatetimeIndex</code>.
That said, <code>DataFrames</code> and <code>Series</code> with a <code>DatetiemIndex</code> do gain some special behaviors and additional methods.</p>
<h2>Special Slicing</h2>
<p>Looking at the elements of <code>gs.index</code>, we see that <code>DatetimeIndex</code>es are made up of <code>pandas.Timestamp</code>s:</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>


<div class="codehilite"><pre><span></span>Timestamp(&#39;2006-01-03 00:00:00&#39;)
</pre></div>


<p>A <code>Timestamp</code> is mostly compatible with the builtin <code>datetime.datetime</code> class, but much amenable to storage in arrays.</p>
<p>Working with <code>Timestamp</code>s can be awkward, so Series and DataFrames with <code>DatetimeIndexes</code> have some special slicing rules.
The first special case is <em>partial-string indexing</em>. Say we wanted to select all the days in 2006. Even with <code>Timestamp</code>'s convenient constructors, it's a pain.</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2006-01-01&#39;</span><span class="p">):</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2006-12-31&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Adj Close</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-03</th>
      <td>126.699997</td>
      <td>129.440002</td>
      <td>124.230003</td>
      <td>128.869995</td>
      <td>6188700</td>
      <td>114.660688</td>
    </tr>
    <tr>
      <th>2006-01-04</th>
      <td>127.349998</td>
      <td>128.910004</td>
      <td>126.379997</td>
      <td>127.089996</td>
      <td>4861600</td>
      <td>113.076954</td>
    </tr>
    <tr>
      <th>2006-01-05</th>
      <td>126.000000</td>
      <td>127.320000</td>
      <td>125.610001</td>
      <td>127.040001</td>
      <td>3717400</td>
      <td>113.032471</td>
    </tr>
    <tr>
      <th>2006-01-06</th>
      <td>127.290001</td>
      <td>129.250000</td>
      <td>127.290001</td>
      <td>128.839996</td>
      <td>4319600</td>
      <td>114.633997</td>
    </tr>
    <tr>
      <th>2006-01-09</th>
      <td>128.500000</td>
      <td>130.619995</td>
      <td>128.000000</td>
      <td>130.389999</td>
      <td>4723500</td>
      <td>116.013096</td>
    </tr>
  </tbody>
</table>
</div>

<p>Thanks to partial-string indexing, it's as simple as</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2006&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Adj Close</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-03</th>
      <td>126.699997</td>
      <td>129.440002</td>
      <td>124.230003</td>
      <td>128.869995</td>
      <td>6188700</td>
      <td>114.660688</td>
    </tr>
    <tr>
      <th>2006-01-04</th>
      <td>127.349998</td>
      <td>128.910004</td>
      <td>126.379997</td>
      <td>127.089996</td>
      <td>4861600</td>
      <td>113.076954</td>
    </tr>
    <tr>
      <th>2006-01-05</th>
      <td>126.000000</td>
      <td>127.320000</td>
      <td>125.610001</td>
      <td>127.040001</td>
      <td>3717400</td>
      <td>113.032471</td>
    </tr>
    <tr>
      <th>2006-01-06</th>
      <td>127.290001</td>
      <td>129.250000</td>
      <td>127.290001</td>
      <td>128.839996</td>
      <td>4319600</td>
      <td>114.633997</td>
    </tr>
    <tr>
      <th>2006-01-09</th>
      <td>128.500000</td>
      <td>130.619995</td>
      <td>128.000000</td>
      <td>130.389999</td>
      <td>4723500</td>
      <td>116.013096</td>
    </tr>
  </tbody>
</table>
</div>

<p>Since label slicing is inclusive, this slice selects any observation where the year is 2006 (and partial-string indexing isn't limited to just years).</p>
<p>The second "convenience" is <code>__getitem__</code> (square-bracket) fall-back indexing. I'm only going to mention it here, with the caveat that you should never use it.
DataFrame <code>__getitem__</code> typically looks in the column: <code>gs['2006']</code> would search <code>gs.columns</code> for <code>'2006'</code>, not find it, and raise a <code>KeyError</code>. But DataFrames with a <code>DatetimeIndex</code> catch that <code>KeyError</code> and try to slice the index.
If it succeeds in slicing the index, the result like <code>gs.loc['2006']</code> is returned.
If it fails, the <code>KeyError</code> is re-raised.
This is confusing because in pretty much every other case<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> <code>DataFrame.__getitem__</code> works on columns, and it's fragile because if you happened to have a column <code>'2006'</code> you <em>would</em> get just that column, and no fall-back indexing would occur. Just use <code>gs.loc['2006']</code> when slicing DataFrame indexes.</p>
<h2>Special Methods</h2>
<h3>Resampling</h3>
<p>Resampling is similar to a <code>groupby</code>: you split the time series into groups (5-day buckets below), apply a function to each group (<code>mean</code>), and combine the result (one row per group).</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;5d&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Adj Close</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-03</th>
      <td>126.834999</td>
      <td>128.730002</td>
      <td>125.877501</td>
      <td>127.959997</td>
      <td>4771825</td>
      <td>113.851027</td>
    </tr>
    <tr>
      <th>2006-01-08</th>
      <td>130.349998</td>
      <td>132.645000</td>
      <td>130.205002</td>
      <td>131.660000</td>
      <td>4664300</td>
      <td>117.143065</td>
    </tr>
    <tr>
      <th>2006-01-13</th>
      <td>131.510002</td>
      <td>133.395005</td>
      <td>131.244995</td>
      <td>132.924995</td>
      <td>3258250</td>
      <td>118.268581</td>
    </tr>
    <tr>
      <th>2006-01-18</th>
      <td>132.210002</td>
      <td>133.853333</td>
      <td>131.656667</td>
      <td>132.543335</td>
      <td>4997766</td>
      <td>118.001965</td>
    </tr>
    <tr>
      <th>2006-01-23</th>
      <td>133.771997</td>
      <td>136.083997</td>
      <td>133.310001</td>
      <td>135.153998</td>
      <td>3968500</td>
      <td>120.476883</td>
    </tr>
  </tbody>
</table>
</div>

<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">Open</th>
      <th colspan="2" halign="left">High</th>
      <th colspan="2" halign="left">Low</th>
      <th colspan="2" halign="left">Close</th>
      <th colspan="2" halign="left">Volume</th>
      <th colspan="2" halign="left">Adj Close</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-08</th>
      <td>126.834999</td>
      <td>507.339996</td>
      <td>128.730002</td>
      <td>514.920006</td>
      <td>125.877501</td>
      <td>503.510002</td>
      <td>127.959997</td>
      <td>511.839988</td>
      <td>4771825</td>
      <td>19087300</td>
      <td>113.851027</td>
      <td>455.404110</td>
    </tr>
    <tr>
      <th>2006-01-15</th>
      <td>130.684000</td>
      <td>653.419998</td>
      <td>132.848001</td>
      <td>664.240006</td>
      <td>130.544000</td>
      <td>652.720001</td>
      <td>131.979999</td>
      <td>659.899994</td>
      <td>4310420</td>
      <td>21552100</td>
      <td>117.427781</td>
      <td>587.138903</td>
    </tr>
    <tr>
      <th>2006-01-22</th>
      <td>131.907501</td>
      <td>527.630005</td>
      <td>133.672501</td>
      <td>534.690003</td>
      <td>131.389999</td>
      <td>525.559998</td>
      <td>132.555000</td>
      <td>530.220000</td>
      <td>4653725</td>
      <td>18614900</td>
      <td>117.994103</td>
      <td>471.976414</td>
    </tr>
    <tr>
      <th>2006-01-29</th>
      <td>133.771997</td>
      <td>668.859986</td>
      <td>136.083997</td>
      <td>680.419983</td>
      <td>133.310001</td>
      <td>666.550003</td>
      <td>135.153998</td>
      <td>675.769989</td>
      <td>3968500</td>
      <td>19842500</td>
      <td>120.476883</td>
      <td>602.384416</td>
    </tr>
    <tr>
      <th>2006-02-05</th>
      <td>140.900000</td>
      <td>704.500000</td>
      <td>142.467999</td>
      <td>712.339996</td>
      <td>139.937998</td>
      <td>699.689988</td>
      <td>141.618002</td>
      <td>708.090011</td>
      <td>3920120</td>
      <td>19600600</td>
      <td>126.238926</td>
      <td>631.194630</td>
    </tr>
  </tbody>
</table>
</div>

<p>You can up-sample to convert to a higher frequency.
The new points are filled with NaNs.</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;6H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Adj Close</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-03 00:00:00</th>
      <td>126.699997</td>
      <td>129.440002</td>
      <td>124.230003</td>
      <td>128.869995</td>
      <td>6188700.0</td>
      <td>114.660688</td>
    </tr>
    <tr>
      <th>2006-01-03 06:00:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2006-01-03 12:00:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2006-01-03 18:00:00</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2006-01-04 00:00:00</th>
      <td>127.349998</td>
      <td>128.910004</td>
      <td>126.379997</td>
      <td>127.089996</td>
      <td>4861600.0</td>
      <td>113.076954</td>
    </tr>
  </tbody>
</table>
</div>

<h3>Rolling / Expanding / EW</h3>
<p>These methods aren't unique to <code>DatetimeIndex</code>es, but they often make sense with time series, so I'll show them here.</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">Close</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Raw&#39;</span><span class="p">)</span>
<span class="n">gs</span><span class="o">.</span><span class="n">Close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;28D MA&#39;</span><span class="p">)</span>
<span class="n">gs</span><span class="o">.</span><span class="n">Close</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Expanding&#39;</span><span class="p">)</span>
<span class="n">gs</span><span class="o">.</span><span class="n">Close</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;EWMA($</span><span class="se">\\</span><span class="s1">alpha=.03$)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.25</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="images/ts-reew.svg" /></p>
<p>Each of <code>.rolling</code>, <code>.expanding</code>, and <code>.ewm</code> return a deferred object, similar to a <code>GroupBy</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">roll</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">Close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">roll</span>
</pre></div>


<div class="codehilite"><pre><span></span>Rolling [window=30,center=True,axis=0]
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">roll</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="ts-roll" src="images/ts-roll.svg" /></p>
<h2>Grab Bag</h2>
<h3>Offsets</h3>
<p>These are similar to <code>dateutil.relativedelta</code>, but they work with arrays.</p>
<div class="codehilite"><pre><span></span><span class="n">gs</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">days</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>DatetimeIndex([&#39;2006-04-01&#39;, &#39;2006-04-02&#39;, &#39;2006-04-03&#39;, &#39;2006-04-04&#39;,
               &#39;2006-04-07&#39;, &#39;2006-04-08&#39;, &#39;2006-04-09&#39;, &#39;2006-04-10&#39;,
               &#39;2006-04-11&#39;, &#39;2006-04-15&#39;,
               ...
               &#39;2010-03-15&#39;, &#39;2010-03-16&#39;, &#39;2010-03-19&#39;, &#39;2010-03-20&#39;,
               &#39;2010-03-21&#39;, &#39;2010-03-22&#39;, &#39;2010-03-26&#39;, &#39;2010-03-27&#39;,
               &#39;2010-03-28&#39;, &#39;2010-03-29&#39;],
              dtype=&#39;datetime64[ns]&#39;, name=&#39;Date&#39;, length=1007, freq=None)
</pre></div>


<h3>Holiday Calendars</h3>
<p>There are a whole bunch of special calendars, useful for traders probably.</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pandas.tseries.holiday</span> <span class="kn">import</span> <span class="n">USColumbusDay</span>

<span class="n">USColumbusDay</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-01-01&#39;</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>DatetimeIndex([&#39;2015-10-12&#39;, &#39;2016-10-10&#39;, &#39;2017-10-09&#39;, &#39;2018-10-08&#39;,
               &#39;2019-10-14&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;WOM-2MON&#39;)
</pre></div>


<h3>Timezones</h3>
<p>Pandas works with <a href="http://pythonhosted.org/pytz/"><code>pytz</code></a> for nice timezone-aware datetimes.
The typical workflow is</p>
<ol>
<li>localize timezone-naive timestamps to some timezone</li>
<li>convert to desired timezone</li>
</ol>
<p>If you already have timezone-aware Timestamps, there's no need for step one.</p>
<div class="codehilite"><pre><span></span><span class="c1"># tz naiive -&gt; tz aware..... to desired UTC</span>
<span class="n">gs</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Adj Close</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-01-03 05:00:00+00:00</th>
      <td>126.699997</td>
      <td>129.440002</td>
      <td>124.230003</td>
      <td>128.869995</td>
      <td>6188700</td>
      <td>114.660688</td>
    </tr>
    <tr>
      <th>2006-01-04 05:00:00+00:00</th>
      <td>127.349998</td>
      <td>128.910004</td>
      <td>126.379997</td>
      <td>127.089996</td>
      <td>4861600</td>
      <td>113.076954</td>
    </tr>
    <tr>
      <th>2006-01-05 05:00:00+00:00</th>
      <td>126.000000</td>
      <td>127.320000</td>
      <td>125.610001</td>
      <td>127.040001</td>
      <td>3717400</td>
      <td>113.032471</td>
    </tr>
    <tr>
      <th>2006-01-06 05:00:00+00:00</th>
      <td>127.290001</td>
      <td>129.250000</td>
      <td>127.290001</td>
      <td>128.839996</td>
      <td>4319600</td>
      <td>114.633997</td>
    </tr>
    <tr>
      <th>2006-01-09 05:00:00+00:00</th>
      <td>128.500000</td>
      <td>130.619995</td>
      <td>128.000000</td>
      <td>130.389999</td>
      <td>4723500</td>
      <td>116.013096</td>
    </tr>
  </tbody>
</table>
</div>

<h1>Modeling Time Series</h1>
<p>The rest of this post will focus on time series in the econometric sense.
My indented reader for this section isn't all that clear, so I apologize upfront for any sudden shifts in complexity.
I'm roughly targeting material that could be presented in a first or second semester applied statistics course, but with more hand-waving and less formality.
I've put a whole bunch of resources at the end for people eager to learn more.</p>
<p>We'll focus on modelling Average Monthly Flights.
If you've been following along in the series, you've seen most of this code for downloading the data before, so feel free to skip this next block.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="kn">as</span> <span class="nn">sm</span>


<span class="k">def</span> <span class="nf">download_one</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Download a single month&#39;s flights</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month_name</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B&#39;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Pragma&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.transtats.bts.gov&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US,en;q=0.8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Upgrade-Insecure-Requests&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.87 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cache-Control&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Referer&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236&amp;DB_Short_Name=On-Time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DNT&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;timeseries&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># long URL truncated, check the notebook</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;UserTableName=On_Time_Performance&amp;DBShortName=On_Time&amp;RawDataTable=T_ONTIME&amp;sqlstr=+SELECT+&#39;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://www.transtats.bts.gov/DownLoad_Table.asp?Table_ID=236&amp;Has_Group=3&amp;Is_Zipped=0&#39;</span><span class="p">,</span>
                      <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">month_name</span><span class="o">=</span><span class="n">month_name</span><span class="p">),</span>
                      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;timeseries&#39;</span><span class="p">,</span> <span class="s1">&#39;{}-{}.zip&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fp</span>

<span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
    <span class="c1"># We could easily parallelize this loop.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">months</span><span class="p">):</span>
        <span class="n">download_one</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unzip_one</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">csv</span>

<span class="k">def</span> <span class="nf">time_to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Combine all time items into datetimes.</span>

<span class="sd">    2014-01-01,1149.0 -&gt; 2014-01-01T11:49:00</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
        <span class="n">timepart</span> <span class="o">=</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;\.0$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># NaNs force float dtype</span>
                       <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fillchar</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">))</span>
        <span class="k">return</span>  <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fl_date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                               <span class="n">timepart</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                               <span class="n">timepart</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                               <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datetime_part</span>
    <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">converter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">read_one</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;unnamed: 21&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">time_to_datetime</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dep_time&#39;</span><span class="p">,</span> <span class="s1">&#39;arr_time&#39;</span><span class="p">,</span> <span class="s1">&#39;crs_arr_time&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;crs_dep_time&#39;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fl_date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fl_date&#39;</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">download_many</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-01-01&#39;</span><span class="p">)</span>

<span class="n">zips</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;timeseries&#39;</span><span class="p">,</span> <span class="s1">&#39;*.zip&#39;</span><span class="p">))</span>
<span class="n">csvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">unzip_one</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">zips</span><span class="p">]</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_one</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">csvs</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">cat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;unique_carrier&#39;</span><span class="p">,</span> <span class="s1">&#39;carrier&#39;</span><span class="p">,</span> <span class="s1">&#39;tail_num&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span><span class="p">]</span>

<span class="n">df</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="s1">&#39;ts.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="s1">&#39;ts.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">)</span>
</pre></div>


<p>We can calculate the historical values with a resample.</p>
<div class="codehilite"><pre><span></span><span class="n">daily</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fl_date</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">y</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span>2000-01-01    1882.387097
2000-02-01    1926.896552
2000-03-01    1951.000000
2000-04-01    1944.400000
2000-05-01    1957.967742
Freq: MS, Name: fl_date, dtype: float64
</pre></div>


<p>Note that I use the <code>"MS"</code> frequency code there.
Pandas defaults to end of month (or end of year).
Append an <code>'S'</code> to get the start.</p>
<div class="codehilite"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Average Monthly Flights&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="images/ts-y.svg" /></p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">statsmodels.tsa.api</span> <span class="kn">as</span> <span class="nn">smt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="kn">as</span> <span class="nn">sm</span>
</pre></div>


<p>One note of warning: I'm using the development version of statsmodels (commit <code>de15ec8</code> to be precise).
Not all of the items I've shown here are available in the currently-released version.</p>
<p>Think back to a typical regression problem, ignoring anything to do with time series for now.
The usual task is to predict some value <span class="math">\(y\)</span> using some a linear combination of features in <span class="math">\(X\)</span>.</p>
<div class="math">$$y = \beta_0 + \beta_1 X_1 + \ldots + \beta_p X_p + \epsilon$$</div>
<p>When working with time series, some of the most important (and sometimes <em>only</em>) features are the previous, or <em>lagged</em>, values of <span class="math">\(y\)</span>.</p>
<p>Let's start by trying just that "manually": running a regression of <code>y</code> on lagged values of itself.
We'll see that this regression suffers from a few problems: multicollinearity, autocorrelation, non-stationarity, and seasonality.
I'll explain what each of those are in turn and why they're problems.
Afterwards, we'll use a second model, seasonal ARIMA, which handles those problems for us.</p>
<p>First, let's create a dataframe with our lagged values of <code>y</code> using the <code>.shift</code> method, which shifts the index <code>i</code> periods, so it lines up with that observation.</p>
<div class="codehilite"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;L</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)])</span>
       <span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="0" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
      <th>L1</th>
      <th>L2</th>
      <th>L3</th>
      <th>L4</th>
      <th>L5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-06-01</th>
      <td>1976.133333</td>
      <td>1957.967742</td>
      <td>1944.400000</td>
      <td>1951.000000</td>
      <td>1926.896552</td>
      <td>1882.387097</td>
    </tr>
    <tr>
      <th>2000-07-01</th>
      <td>1937.032258</td>
      <td>1976.133333</td>
      <td>1957.967742</td>
      <td>1944.400000</td>
      <td>1951.000000</td>
      <td>1926.896552</td>
    </tr>
    <tr>
      <th>2000-08-01</th>
      <td>1960.354839</td>
      <td>1937.032258</td>
      <td>1976.133333</td>
      <td>1957.967742</td>
      <td>1944.400000</td>
      <td>1951.000000</td>
    </tr>
    <tr>
      <th>2000-09-01</th>
      <td>1900.533333</td>
      <td>1960.354839</td>
      <td>1937.032258</td>
      <td>1976.133333</td>
      <td>1957.967742</td>
      <td>1944.400000</td>
    </tr>
    <tr>
      <th>2000-10-01</th>
      <td>1931.677419</td>
      <td>1900.533333</td>
      <td>1960.354839</td>
      <td>1937.032258</td>
      <td>1976.133333</td>
      <td>1957.967742</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can fit the lagged model using statsmodels (which uses <a href="http://patsy.readthedocs.org">patsy</a> to translate the formula string to a design matrix).</p>
<div class="codehilite"><pre><span></span><span class="n">mod_lagged</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;y ~ trend + L1 + L2 + L3 + L4 + L5&#39;</span><span class="p">,</span>
                     <span class="n">data</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))))</span>
<span class="n">res_lagged</span> <span class="o">=</span> <span class="n">mod_lagged</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">res_lagged</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>


<table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>            <td>y</td>        <th>  R-squared:         </th> <td>   0.881</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.877</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   221.7</td>
</tr>
<tr>
  <th>Date:</th>             <td>Fri, 13 May 2016</td> <th>  Prob (F-statistic):</th> <td>2.40e-80</td>
</tr>
<tr>
  <th>Time:</th>                 <td>16:14:16</td>     <th>  Log-Likelihood:    </th> <td> -1076.6</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>   187</td>      <th>  AIC:               </th> <td>   2167.</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>   180</td>      <th>  BIC:               </th> <td>   2190.</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     6</td>      <th>                     </th>     <td> </td>
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>
</tr>
</table>

<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>
</tr>
<tr>
  <th>Intercept</th> <td>  208.2440</td> <td>   65.495</td> <td>    3.180</td> <td> 0.002</td> <td>   79.008</td> <td>  337.480</td>
</tr>
<tr>
  <th>trend</th>     <td>   -0.1123</td> <td>    0.106</td> <td>   -1.055</td> <td> 0.293</td> <td>   -0.322</td> <td>    0.098</td>
</tr>
<tr>
  <th>L1</th>        <td>    1.0489</td> <td>    0.075</td> <td>   14.052</td> <td> 0.000</td> <td>    0.902</td> <td>    1.196</td>
</tr>
<tr>
  <th>L2</th>        <td>   -0.0001</td> <td>    0.108</td> <td>   -0.001</td> <td> 0.999</td> <td>   -0.213</td> <td>    0.213</td>
</tr>
<tr>
  <th>L3</th>        <td>   -0.1450</td> <td>    0.108</td> <td>   -1.346</td> <td> 0.180</td> <td>   -0.358</td> <td>    0.068</td>
</tr>
<tr>
  <th>L4</th>        <td>   -0.0393</td> <td>    0.109</td> <td>   -0.361</td> <td> 0.719</td> <td>   -0.254</td> <td>    0.175</td>
</tr>
<tr>
  <th>L5</th>        <td>    0.0506</td> <td>    0.074</td> <td>    0.682</td> <td> 0.496</td> <td>   -0.096</td> <td>    0.197</td>
</tr>
</table>

<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>55.872</td> <th>  Durbin-Watson:     </th> <td>   2.009</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.000</td> <th>  Jarque-Bera (JB):  </th> <td> 322.488</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.956</td> <th>  Prob(JB):          </th> <td>9.39e-71</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 9.142</td> <th>  Cond. No.          </th> <td>5.97e+04</td>
</tr>
</table>

<p>There are a few problems with this approach though.
Since our lagged values are highly correlated with each other, our regression suffers from <a href="https://en.wikipedia.org/wiki/Multicollinearity">multicollinearity</a>.
That ruins our estimates of the slopes.</p>
<div class="codehilite"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span>
</pre></div>


<p><img alt="png" src="images/ts-corr.svg" /></p>
<p>Second, we'd intuitively expect the <span class="math">\(\beta_i\)</span>s to gradually decline to zero.
The immediately preceding period <em>should</em> be most important (<span class="math">\(\beta_1\)</span> is the largest coefficient in absolute value), followed by <span class="math">\(\beta_2\)</span>, and <span class="math">\(\beta_3\)</span>...
Looking at the regression summary and the bar graph below, this isn't the case (the cause is related to multicollinearity).</p>
<div class="codehilite"><pre><span></span><span class="n">res_lagged</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Intercept&#39;</span><span class="p">,</span> <span class="s1">&#39;trend&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coefficeint&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="images/ts-lagged-coef.svg" /></p>
<p>Finally, our degrees of freedom drop since we lose two for each variable (one for estimating the coefficient, one for the lost observation as a result of the <code>shift</code>).
At least in (macro)econometrics, each observation is precious and we're loath to throw them away, though sometimes that's unavoidable.</p>
<h3>Autocorrelation</h3>
<p>Another problem our lagged model suffered from is <a href="https://en.wikipedia.org/wiki/Autocorrelation">autocorrelation</a> (also know as serial correlation).
Roughly speaking, autocorrelation is when there's a clear pattern in the residuals of your regression (the observed minus the predicted).
Let's fit a simple model of <span class="math">\(y = \beta_0 + \beta_1 T + \epsilon\)</span>, where <code>T</code> is the time trend (<code>np.arange(len(y))</code>).</p>
<div class="codehilite"><pre><span></span><span class="c1"># `Results.resid` is a Series of residuals: y - ŷ</span>
<span class="n">mod_trend</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
    <span class="s1">&#39;y ~ trend&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))))</span>
<span class="n">res_trend</span> <span class="o">=</span> <span class="n">mod_trend</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>


<p>Residuals (the observed minus the expected, or <span class="math">\(\hat{e_t} = y_t - \hat{y_t}\)</span>) are supposed to be <a href="https://en.wikipedia.org/wiki/White_noise">white noise</a>.
That's <a href="https://en.wikipedia.org/wiki/Gauss–Markov_theorem">one of the assumptions</a> many of the properties of linear regression are founded upon.
In this case there's a correlation between one residual and the next: if the residual at time <span class="math">\(t\)</span> was above expectation, then the residual at time <span class="math">\(t + 1\)</span> is <em>much</em> more likely to be above average as well (<span class="math">\(e_t &gt; 0 \implies E_t[e_{t+1}] &gt; 0\)</span>).</p>
<p>We'll define a helper function to plot the residuals time series, and some diagnostics about them.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">tsplot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ts_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">acf_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">pacf_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ts_ax</span><span class="p">)</span>
    <span class="n">smt</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_acf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">acf_ax</span><span class="p">)</span>
    <span class="n">smt</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_pacf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pacf_ax</span><span class="p">)</span>
    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">acf_ax</span><span class="p">,</span> <span class="n">pacf_ax</span><span class="p">]]</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ts_ax</span><span class="p">,</span> <span class="n">acf_ax</span><span class="p">,</span> <span class="n">pacf_ax</span>
</pre></div>


<p>Calling it on the residuals from the linear trend:</p>
<div class="codehilite"><pre><span></span><span class="n">tsplot</span><span class="p">(</span><span class="n">res_trend</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="images/ts-res-trend-tsplot.svg" /></p>
<p>The top subplot shows the time series of our residuals <span class="math">\(e_t\)</span>, which should be white noise (but it isn't).
The bottom shows the <a href="https://www.otexts.org/fpp/2/2#autocorrelation">autocorrelation</a> of the residuals as a correlogram.
It measures the correlation between a value and it's lagged self, e.g. <span class="math">\(corr(e_t, e_{t-1}), corr(e_t, e_{t-2}), \ldots\)</span>.
The partial autocorrelation plot in the bottom-right shows a similar concept.
It's partial in the sense that the value for <span class="math">\(corr(e_t, e_{t-k})\)</span> is the correlation between those two periods, after controlling for the values at all shorter lags.</p>
<p>Autocorrelation is a problem in regular regressions like above, but we'll use it to our advantage when we setup an ARIMA model below.
The basic idea is pretty sensible: if your regression residuals have a clear pattern, then there's clearly some structure in the data that you aren't taking advantage of.
If a positive residual today means you'll likely have a positive residual tomorrow, why not incorporate that information into your forecast, and lower your forecasted value for tomorrow?
That's pretty much what ARIMA does.</p>
<h2>Stationarity</h2>
<p>It's important that your dataset be stationary, otherwise you run the risk of finding <a href="http://www.tylervigen.com/spurious-correlations">spurious correlations</a>.
A common example is the relationship between number of TVs per person and life expectancy.
It's not likely that there's an actual causal relationship there.
Rather, there could be a third variable that's driving both (wealth, say).
<a href="http://wolfweb.unr.edu/homepage/zal/STAT758/Granger_Newbold_1974.pdf">Granger and Newbold (1974)</a> had some stern words for the econometrics literature on this.</p>
<blockquote>
<p>We find it very curious that whereas virtually every textbook on econometric methodology contains explicit warnings of the dangers of autocorrelated errors, this phenomenon crops up so frequently in well-respected applied work.</p>
</blockquote>
<p>(:fire:), but in that academic passive-aggressive way.</p>
<p>The typical way to handle non-stationarity is to difference the non-stationary variable until is is stationary.</p>
<div class="codehilite"><pre><span></span><span class="n">y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="err">Δ</span><span class="n">y</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="images/ts-y-deltay.svg" /></p>
<p>Our original series actually doesn't look <em>that</em> bad.
It doesn't look like nominal GDP say, where there's a clearly rising trend.
But we have more rigorous methods for detecting whether a series is non-stationary than simply plotting and squinting at it.
One popular method is the Augmented Dickey-Fuller test.
It's a statistical hypothesis test that roughly says:</p>
<p><span class="math">\(H_0\)</span> (null hypothesis): <span class="math">\(y\)</span> is non-stationary, needs to be differenced</p>
<p><span class="math">\(H_A\)</span> (alternative hypothesis): <span class="math">\(y\)</span> is stationary, doesn't need to be differenced</p>
<p>I don't want to get into the weeds on exactly what the test statistic is, and what the distribution looks like.
This is implemented in statsmodels as <a href="http://www.statsmodels.org/dev/generated/statsmodels.tsa.stattools.adfuller.html"><code>smt.adfuller</code></a>.
The return type is a bit busy for me, so we'll wrap it in a <code>namedtuple</code>.</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">ADF</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;ADF&quot;</span><span class="p">,</span> <span class="s2">&quot;adf pvalue usedlag nobs critical icbest&quot;</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">ADF</span><span class="p">(</span><span class="o">*</span><span class="n">smt</span><span class="o">.</span><span class="n">adfuller</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>  <span class="c1"># for pretty-printing</span>
</pre></div>


<div class="codehilite"><pre><span></span>OrderedDict([(&#39;adf&#39;, -1.9904608794641487),
             (&#39;pvalue&#39;, 0.29077127047555601),
             (&#39;usedlag&#39;, 15),
             (&#39;nobs&#39;, 176),
             (&#39;critical&#39;,
              {&#39;1%&#39;: -3.4680615871598537,
               &#39;10%&#39;: -2.5756015922004134,
               &#39;5%&#39;: -2.8781061899535128}),
             (&#39;icbest&#39;, 1987.6605732826176)])
</pre></div>


<p>So we failed to reject the null hypothesis that the original series was non-stationary.
Let's difference it.</p>
<div class="codehilite"><pre><span></span><span class="n">ADF</span><span class="p">(</span><span class="o">*</span><span class="n">smt</span><span class="o">.</span><span class="n">adfuller</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()))</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span>OrderedDict([(&#39;adf&#39;, -3.5862361055645211),
             (&#39;pvalue&#39;, 0.0060296818910968268),
             (&#39;usedlag&#39;, 14),
             (&#39;nobs&#39;, 176),
             (&#39;critical&#39;,
              {&#39;1%&#39;: -3.4680615871598537,
               &#39;10%&#39;: -2.5756015922004134,
               &#39;5%&#39;: -2.8781061899535128}),
             (&#39;icbest&#39;, 1979.6445486427308)])
</pre></div>


<p>This looks better.
We'll fit another OLS model of <span class="math">\(\Delta y = \beta_0 + \beta_1 L \Delta y_{t-1} + e_t\)</span></p>
<div class="codehilite"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="err">Δ</span><span class="n">y</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">LΔy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="err">Δ</span><span class="n">y</span><span class="o">.</span><span class="n">shift</span><span class="p">()))</span>
<span class="n">mod_stationary</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;Δy ~ LΔy&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
<span class="n">res_stationary</span> <span class="o">=</span> <span class="n">mod_stationary</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">tsplot</span><span class="p">(</span><span class="n">res_stationary</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="images/ts-stationary.svg" /></p>
<p>This is better, but we still see a regular cycle in the residuals.
The cause is seasonality.</p>
<h2>Seasonality</h2>
<p>We have strong monthly seasonality:</p>
<div class="codehilite"><pre><span></span><span class="n">smt</span><span class="o">.</span><span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<p><img alt="ts-decompose" src="images/ts-decompose.svg" /></p>
<p>There are a few ways to handle seasonality.
We'll just rely on the <code>SARIMAX</code> method to do it for us.
For now, recognize that it's a problem to be solved.</p>
<h2>ARIMA</h2>
<p>So, we've sketched the problems with regular old regression: multicollinearity, autocorrelation, non-stationarity, and seasonality.
Our tool of choice, <code>smt.SARIMAX</code>, which stands for Seasonal ARIMA with eXogenous regressors, can handle all these.
We'll walk through the components in pieces.</p>
<p>ARIMA stands for AutoRegressive Integrated Moving Average.
It's a relatively simple yet flexible way of modeling univariate time series.
It's made up of three components, and is typically written as <span class="math">\(\mathrm{ARIMA}(p, d, q)\)</span>.</p>
<h3><a href="https://www.otexts.org/fpp/8/3">AutoRegressive</a></h3>
<p>The idea is to predict a variable by a linear combination of its lagged values (<em>auto</em>-regressive as in regressing a value on its past <em>self</em>).
An AR(p), where <span class="math">\(p\)</span> represents the number of lagged values used, is written as</p>
<div class="math">$$y_t = c + \phi_1 y_{t-1} + \phi_2 y_{t-2} + \ldots + \phi_p y_{t-p} + e_t$$</div>
<p><span class="math">\(c\)</span> is a constant and <span class="math">\(e_t\)</span> is white noise.
This looks a lot like a linear regression model with multiple predictors, but the predictors happen to be lagged values of <span class="math">\(y\)</span> (though they are estimated differently).</p>
<h3>Integrated</h3>
<p>Integrated is like the opposite of differencing, and is the part that deals with stationarity.
If you have to difference your dataset 1 time to get it stationary, then <span class="math">\(d=1\)</span>, and your series is integrated of order 1.
We'll introduce one bit of notation for differencing: <span class="math">\(\Delta y_t = y_t - y_{t-1}\)</span> for <span class="math">\(d=1\)</span>.</p>
<h3><a href="https://www.otexts.org/fpp/8/4">Moving Average</a></h3>
<p>MA models look somewhat similar to the AR component, but it's dealing with different values.</p>
<div class="math">$$y_t = c + e_t + \theta_1 e_{t-1} + \theta_2 e_{t-2} + \ldots + \theta_q e_{t-q}$$</div>
<p><span class="math">\(c\)</span> again is a constant and <span class="math">\(e_t\)</span> again is white noise.
But now the coefficients are multiplying the <em>residuals</em> from previous predictions, not the actual (or differenced) values.</p>
<h3>Combining</h3>
<p>Putting that together, an ARIMA(1, 1, 1) process is written as</p>
<div class="math">$$\Delta y_t = c + \phi_1 \Delta y_{t-1} + \theta_t e_{t-1} + e_t$$</div>
<p>Using <em>lag notation</em>, where <span class="math">\(L y_t = y_{t-1}\)</span>, i.e. <code>y.shift()</code> in pandas, we can rewrite that as</p>
<div class="math">$$(1 - \phi_1 L) (1 - L)y_t = c + (1 + \theta L)e_t$$</div>
<p>That was for our specific <span class="math">\(\mathrm{ARIMA}(1, 1, 1)\)</span> model. For the general <span class="math">\(\mathrm{ARIMA}(p, d, q)\)</span>, that becomes</p>
<div class="math">$$(1 - \phi_1 L - \ldots - \phi_p L^p) (1 - L)^d y_t = c + (1 + \theta L + \ldots + \theta_q L^q)e_t$$</div>
<p>We went through that <em>extremely</em> quickly, so don't feel bad if things aren't clear.
Fortunately, the model is pretty easy to use with statsmodels.</p>
<div class="codehilite"><pre><span></span><span class="n">mod</span> <span class="o">=</span> <span class="n">smt</span><span class="o">.</span><span class="n">SARIMAX</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">tsplot</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="images/ts-arima.svg" /></p>
<div class="codehilite"><pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>


<table class="simpletable">
<caption>Statespace Model Results</caption>
<tr>
  <th>Dep. Variable:</th>        <td>fl_date</td>     <th>  No. Observations:  </th>    <td>192</td>
</tr>
<tr>
  <th>Model:</th>           <td>SARIMAX(1, 1, 1)</td> <th>  Log Likelihood     </th> <td>-1104.663</td>
</tr>
<tr>
  <th>Date:</th>            <td>Fri, 13 May 2016</td> <th>  AIC                </th> <td>2217.326</td>
</tr>
<tr>
  <th>Time:</th>                <td>16:16:27</td>     <th>  BIC                </th> <td>2230.356</td>
</tr>
<tr>
  <th>Sample:</th>             <td>01-01-2000</td>    <th>  HQIC               </th> <td>2222.603</td>
</tr>
<tr>
  <th></th>                   <td>- 12-01-2015</td>   <th>                     </th>     <td> </td>
</tr>
<tr>
  <th>Covariance Type:</th>        <td>opg</td>       <th>                     </th>     <td> </td>
</tr>
</table>

<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>
</tr>
<tr>
  <th>intercept</th> <td>    0.7993</td> <td>    4.959</td> <td>    0.161</td> <td> 0.872</td> <td>   -8.921</td> <td>   10.519</td>
</tr>
<tr>
  <th>ar.L1</th>     <td>    0.3515</td> <td>    0.564</td> <td>    0.623</td> <td> 0.533</td> <td>   -0.754</td> <td>    1.457</td>
</tr>
<tr>
  <th>ma.L1</th>     <td>   -0.2310</td> <td>    0.577</td> <td>   -0.400</td> <td> 0.689</td> <td>   -1.361</td> <td>    0.899</td>
</tr>
<tr>
  <th>sigma2</th>    <td> 6181.2832</td> <td>  350.439</td> <td>   17.639</td> <td> 0.000</td> <td> 5494.435</td> <td> 6868.131</td>
</tr>
</table>

<table class="simpletable">
<tr>
  <th>Ljung-Box (Q):</th>          <td>209.30</td> <th>  Jarque-Bera (JB):  </th> <td>424.36</td>
</tr>
<tr>
  <th>Prob(Q):</th>                 <td>0.00</td>  <th>  Prob(JB):          </th>  <td>0.00</td>
</tr>
<tr>
  <th>Heteroskedasticity (H):</th>  <td>0.86</td>  <th>  Skew:              </th>  <td>1.15</td>
</tr>
<tr>
  <th>Prob(H) (two-sided):</th>     <td>0.54</td>  <th>  Kurtosis:          </th>  <td>9.93</td>
</tr>
</table>

<p>There's a bunch of output there with various tests, estimated parameters, and information criteria.
Let's just say that things are looking better, but we still haven't accounted for seasonality.</p>
<p>A seasonal ARIMA model is written as <span class="math">\(\mathrm{ARIMA}(p,d,q)×(P,D,Q)_s\)</span>.
Lowercase letters are for the non-seasonal component, just like before. Upper-case letters are a similar specification for the seasonal component, where <span class="math">\(s\)</span> is the periodicity (4 for quarterly, 12 for monthly).</p>
<p>It's like we have two processes, one for non-seasonal component and one for seasonal components, and we multiply them together with regular algebra rules.</p>
<p>The general form of that looks like (quoting the <a href="http://www.statsmodels.org/dev/examples/notebooks/generated/statespace_sarimax_stata.html">statsmodels docs</a> here)</p>
<div class="math">$$\phi_p(L)\tilde{\phi}_P(L^S)\Delta^d\Delta_s^D y_t = A(t) + \theta_q(L)\tilde{\theta}_Q(L^s)e_t$$</div>
<p>where</p>
<ul>
<li><span class="math">\(\phi_p(L)\)</span> is the non-seasonal autoregressive lag polynomial</li>
<li><span class="math">\(\tilde{\phi}_P(L^S)\)</span> is the seasonal autoregressive lag polynomial</li>
<li><span class="math">\(\Delta^d\Delta_s^D\)</span> is the time series, differenced  <span class="math">\(d\)</span> times, and seasonally differenced <span class="math">\(D\)</span> times.</li>
<li><span class="math">\(A(t)\)</span> is the trend polynomial (including the intercept)</li>
<li><span class="math">\(\theta_q(L)\)</span> is the non-seasonal moving average lag polynomial</li>
<li><span class="math">\(\tilde{\theta}_Q(L^s)\)</span>  is the seasonal moving average lag polynomial</li>
</ul>
<p>I don't find that to be very clear, but maybe an example will help.
We'll fit a seasonal ARIMA<span class="math">\((2,0,1)×(0, 1, 2)_{12}\)</span>.</p>
<p>So the nonseasonal component is</p>
<ul>
<li><span class="math">\(p=2\)</span>: period autoregressive: use <span class="math">\(y_{t-1}\)</span> and <span class="math">\(y_{t-2}\)</span></li>
<li><span class="math">\(d=0\)</span>: no first-differencing of the data</li>
<li><span class="math">\(q=1\)</span>: use the previous non-seasonal residual, <span class="math">\(e_{t-1}\)</span>, to forecast</li>
</ul>
<p>And the seasonal component is</p>
<ul>
<li><span class="math">\(P=0\)</span>: Don't use any previous seasonal values</li>
<li><span class="math">\(D=1\)</span>: Difference the series 12 periods back: <code>y.diff(12)</code></li>
<li><span class="math">\(Q=2\)</span>: Use the two previous seasonal residuals</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">mod_seasonal</span> <span class="o">=</span> <span class="n">smt</span><span class="o">.</span><span class="n">SARIMAX</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                           <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">res_seasonal</span> <span class="o">=</span> <span class="n">mod_seasonal</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">res_seasonal</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>


<table class="simpletable">
<caption>Statespace Model Results</caption>
<tr>
  <th>Dep. Variable:</th>               <td>fl_date</td>            <th>  No. Observations:  </th>    <td>192</td>
</tr>
<tr>
  <th>Model:</th>           <td>SARIMAX(1, 1, 2)x(0, 1, 2, 12)</td> <th>  Log Likelihood     </th> <td>-992.148</td>
</tr>
<tr>
  <th>Date:</th>                   <td>Fri, 13 May 2016</td>        <th>  AIC                </th> <td>1998.297</td>
</tr>
<tr>
  <th>Time:</th>                       <td>16:16:31</td>            <th>  BIC                </th> <td>2021.099</td>
</tr>
<tr>
  <th>Sample:</th>                    <td>01-01-2000</td>           <th>  HQIC               </th> <td>2007.532</td>
</tr>
<tr>
  <th></th>                          <td>- 12-01-2015</td>          <th>                     </th>     <td> </td>
</tr>
<tr>
  <th>Covariance Type:</th>               <td>opg</td>              <th>                     </th>     <td> </td>
</tr>
</table>

<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>
</tr>
<tr>
  <th>intercept</th> <td>    0.7824</td> <td>    5.279</td> <td>    0.148</td> <td> 0.882</td> <td>   -9.564</td> <td>   11.129</td>
</tr>
<tr>
  <th>ar.L1</th>     <td>   -0.9880</td> <td>    0.374</td> <td>   -2.639</td> <td> 0.008</td> <td>   -1.722</td> <td>   -0.254</td>
</tr>
<tr>
  <th>ma.L1</th>     <td>    0.9905</td> <td>    0.437</td> <td>    2.265</td> <td> 0.024</td> <td>    0.133</td> <td>    1.847</td>
</tr>
<tr>
  <th>ma.L2</th>     <td>    0.0041</td> <td>    0.091</td> <td>    0.045</td> <td> 0.964</td> <td>   -0.174</td> <td>    0.182</td>
</tr>
<tr>
  <th>ma.S.L12</th>  <td>   -0.7869</td> <td>    0.066</td> <td>  -11.972</td> <td> 0.000</td> <td>   -0.916</td> <td>   -0.658</td>
</tr>
<tr>
  <th>ma.S.L24</th>  <td>    0.2121</td> <td>    0.063</td> <td>    3.366</td> <td> 0.001</td> <td>    0.089</td> <td>    0.336</td>
</tr>
<tr>
  <th>sigma2</th>    <td> 3645.3299</td> <td>  219.296</td> <td>   16.623</td> <td> 0.000</td> <td> 3215.518</td> <td> 4075.142</td>
</tr>
</table>

<table class="simpletable">
<tr>
  <th>Ljung-Box (Q):</th>          <td>47.28</td> <th>  Jarque-Bera (JB):  </th> <td>464.42</td>
</tr>
<tr>
  <th>Prob(Q):</th>                <td>0.20</td>  <th>  Prob(JB):          </th>  <td>0.00</td>
</tr>
<tr>
  <th>Heteroskedasticity (H):</th> <td>0.29</td>  <th>  Skew:              </th>  <td>-1.30</td>
</tr>
<tr>
  <th>Prob(H) (two-sided):</th>    <td>0.00</td>  <th>  Kurtosis:          </th>  <td>10.45</td>
</tr>
</table>

<div class="codehilite"><pre><span></span><span class="n">tsplot</span><span class="p">(</span><span class="n">res_seasonal</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="mi">12</span><span class="p">:],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>


<p><img alt="ts-seasonal" src="images/ts-seasonal.svg" /></p>
<p>Things look much better now.</p>
<p>One thing I didn't really talk about is order selection. How to choose <span class="math">\(p, d, q, P, D\)</span> and <span class="math">\(Q\)</span>.
R's forecast package does have a handy <code>auto.arima</code> function that does this for you.
Python / statsmodels don't have that at the minute.
The alternative seems to be experience (boo), intuition (boo), and good-old grid-search.
You can fit a bunch of models for a bunch of combinations of the parameters and use the <a href="https://en.wikipedia.org/wiki/Akaike_information_criterion">AIC</a> or <a href="https://en.wikipedia.org/wiki/Bayesian_information_criterion">BIC</a> to choose the best.
<a href="https://www.otexts.org/fpp/8/7">Here</a> is a useful reference, and <a href="http://stackoverflow.com/a/22770973">this</a> StackOverflow answer recommends a few options.</p>
<h2>Forecasting</h2>
<p>Now that we fit that model, let's put it to use.
First, we'll make a bunch of one-step ahead forecasts.
At each point (month), we take the history up to that point and make a forecast for the next month.
So the forecast for January 2014 has available all the data up through December 2013.</p>
<div class="codehilite"><pre><span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">res_seasonal</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2001-03-01&#39;</span><span class="p">)</span>
<span class="n">pred_ci</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed&#39;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">predicted_mean</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pred_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">pred_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">pred_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="images/ts-one-step.svg" /></p>
<p>There are a few places where the observed series slips outside the 95% confidence interval.
The series seems especially unstable before 2005.</p>
<p>Alternatively, we can make <em>dynamic</em> forecasts as of some month (January 2013 in the example below).
That means the forecast from that point forward only use information available as of January 2013.
The predictions are generated in a similar way: a bunch of one-step forecasts.
Only instead of plugging in the <em>actual</em> values beyond January 2013, we plug in the <em>forecast</em> values.</p>
<div class="codehilite"><pre><span></span><span class="n">pred_dy</span> <span class="o">=</span> <span class="n">res_seasonal</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2002-03-01&#39;</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="s1">&#39;2013-01-01&#39;</span><span class="p">)</span>
<span class="n">pred_dy_ci</span> <span class="o">=</span> <span class="n">pred_dy</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed&#39;</span><span class="p">)</span>
<span class="n">pred_dy</span><span class="o">.</span><span class="n">predicted_mean</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pred_dy_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">pred_dy_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">pred_dy_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2013-01-01&#39;</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Dynamic $</span><span class="se">\\</span><span class="s1">longrightarrow$&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2013-02-01&#39;</span><span class="p">),</span> <span class="mi">550</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="images/ts-dynamic.svg" /></p>
<h2>Resources</h2>
<p>This is a collection of links for those interested.</p>
<h3>Time series modeling in Python</h3>
<ul>
<li><a href="http://www.statsmodels.org/dev/examples/index.html#statespace">Statsmodels Statespace Notebooks</a></li>
<li><a href="http://www.statsmodels.org/dev/vector_ar.html#var">Statsmodels VAR tutorial</a></li>
<li><a href="https://github.com/bashtage/arch">ARCH Library by Kevin Sheppard</a></li>
</ul>
<h3>General Textbooks</h3>
<ul>
<li><a href="https://www.otexts.org/fpp/">Forecasting: Principles and Practice</a>: A great introduction</li>
<li><a href="http://wps.aw.com/aw_stock_ie_3/178/45691/11696965.cw/">Stock and Watson</a>: Readable undergraduate resource, has a few chapters on time series</li>
<li><a href="http://pages.stern.nyu.edu/~wgreene/Text/econometricanalysis.htm">Greene's Econometric Analysis</a>: My favorite PhD level textbook</li>
<li><a href="http://www.amazon.com/Time-Analysis-James-Douglas-Hamilton/dp/0691042896">Hamilton's Time Series Analysis</a>: A classic</li>
<li><a href="http://www.amazon.com/New-Introduction-Multiple-Time-Analysis/dp/3540262393">Lutkehpohl's New Introduction to Multiple Time Series Analysis</a>: Extremely dry, but useful if you're implementing this stuff</li>
</ul>
<h1>Conclusion</h1>
<p>Congratulations if you made it this far, this piece just kept growing (and I still had to cut stuff).
The main thing cut was talking about how <code>SARIMAX</code> is implemented on top of using statsmodels' statespace framework.
The statespace framework, developed mostly by Chad Fulton over the past couple years, is really nice.
You can pretty easily <a href="http://www.statsmodels.org/dev/examples/notebooks/generated/statespace_local_linear_trend.html">extend it</a> with custom models, but still get all the benefits of the framework's estimation and results facilities.
I'd recommend reading the <a href="http://www.statsmodels.org/dev/examples/index.html#statespace">notebooks</a>.
We also didn't get to talk at all about Skipper Seabold's work on VARs, but maybe some other time.</p>
<p>As always, <a href="https://twitter.com/tomaugspurger">feedback is welcome</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The only other one is boolean indexing. I think that one is fine since you're passing in an <em>array</em> of booleans, not a label.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }
    
    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript'; 
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
  </div><!-- /.entry-content -->
</section>

    <footer>
      <p>&copy; Tom Augspurger </p>
    </footer>
  </main>

</body>
</html>